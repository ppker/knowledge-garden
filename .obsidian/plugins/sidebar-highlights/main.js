/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var st=Object.defineProperty;var rt=Object.getOwnPropertyDescriptor;var at=Object.getOwnPropertyNames;var ct=Object.prototype.hasOwnProperty;var ht=(I,o)=>{for(var t in o)st(I,t,{get:o[t],enumerable:!0})},gt=(I,o,t,e)=>{if(o&&typeof o=="object"||typeof o=="function")for(let i of at(o))!ct.call(I,i)&&i!==t&&st(I,i,{get:()=>o[i],enumerable:!(e=rt(o,i))||e.enumerable});return I};var dt=I=>gt(st({},"__esModule",{value:!0}),I);var pt={};ht(pt,{CollectionsManager:()=>Q,default:()=>X});module.exports=dt(pt);var E=require("obsidian");var C=require("obsidian");var P=require("obsidian"),W=class extends P.Modal{constructor(t,e){super(t);this.onSubmit=e}onOpen(){let{contentEl:t}=this;t.empty(),t.createEl("h3",{text:"Create a new collection"}),new P.Setting(t).setName("Collection name").setDesc("The name of your collection (Required)").addText(n=>{this.nameInput=n.inputEl,n.setPlaceholder("Important Highlights").onChange(a=>{let r=t.querySelector(".mod-cta");r&&(r.disabled=!a.trim())}),window.setTimeout(()=>n.inputEl.focus(),100)}),new P.Setting(t).setName("Collection description").setDesc("Provide more context about the collection (Optional)").addText(n=>{this.descriptionInput=n.inputEl,n.setPlaceholder("Research, etc.")});let e=t.createDiv({cls:"modal-button-container"});e.createEl("button",{text:"Cancel"}).addEventListener("click",()=>this.close());let s=e.createEl("button",{text:"Create collection",cls:"mod-cta"});s.disabled=!0,s.addEventListener("click",()=>this.handleSubmit()),t.addEventListener("keydown",n=>{n.key==="Enter"&&(n.ctrlKey||n.metaKey)?this.handleSubmit():n.key==="Escape"&&this.close()})}handleSubmit(){let t=this.nameInput.value.trim(),e=this.descriptionInput.value.trim();if(!t){new P.Notice("Collection name is required"),this.nameInput.focus();return}this.onSubmit(t,e),this.close()}onClose(){let{contentEl:t}=this;t.empty()}},_=class extends P.Modal{constructor(t,e,i){super(t);this.collection=e,this.onSubmit=i}onOpen(){let{contentEl:t}=this;t.empty(),t.createEl("h3",{text:"Edit collection"}),new P.Setting(t).setName("Collection name").setDesc("The name of your collection (Required)").addText(n=>{this.nameInput=n.inputEl,n.setPlaceholder("Important Highlights").setValue(this.collection.name).onChange(a=>{let r=t.querySelector(".mod-cta");r&&(r.disabled=!a.trim())}),window.setTimeout(()=>{n.inputEl.focus(),n.inputEl.select()},100)}),new P.Setting(t).setName("Collection description").setDesc("Provide more context about the collection (Optional)").addText(n=>{this.descriptionInput=n.inputEl,n.setPlaceholder("Research, etc.").setValue(this.collection.description||"")});let e=t.createDiv({cls:"modal-button-container"});e.createEl("button",{text:"Cancel"}).addEventListener("click",()=>this.close()),e.createEl("button",{text:"Save changes",cls:"mod-cta"}).addEventListener("click",()=>this.handleSubmit()),t.addEventListener("keydown",n=>{n.key==="Enter"&&(n.ctrlKey||n.metaKey)?this.handleSubmit():n.key==="Escape"&&this.close()})}handleSubmit(){let t=this.nameInput.value.trim(),e=this.descriptionInput.value.trim();if(!t){new P.Notice("Collection name is required"),this.nameInput.focus();return}this.onSubmit(t,e),this.close()}onClose(){let{contentEl:t}=this;t.empty()}};var R=require("obsidian"),z=class{constructor(){this.activeDropdown=null;this.documentClickHandlers=[];this.keydownHandlers=[];this.isOpen=!1;this.checkboxElements=new Map;this.activeItems=[]}isDropdownOpen(){return this.isOpen}closeActiveDropdown(){this.activeDropdown&&this.activeDropdown.parentNode&&(this.activeDropdown.classList.remove("dropdown-constrained-height"),this.activeDropdown.style.removeProperty("--dropdown-max-height"),this.activeDropdown.style.removeProperty("--dropdown-top"),this.activeDropdown.style.removeProperty("--dropdown-left"),this.activeDropdown.parentNode.removeChild(this.activeDropdown)),this.activeDropdown=null,this.isOpen=!1,this.checkboxElements.clear(),this.activeItems=[],this.documentClickHandlers.forEach(o=>{document.removeEventListener("click",o)}),this.documentClickHandlers=[],this.keydownHandlers.forEach(o=>{document.removeEventListener("keydown",o)}),this.keydownHandlers=[]}showDropdown(o,t,e={position:"below"}){if(this.isOpen){this.closeActiveDropdown();return}let i=o.getBoundingClientRect(),s=document.createElement("div");s.className=`menu highlights-dropdown-menu ${e.className||""}`,s.classList.add("dropdown-positioned"),this.activeDropdown=s,this.isOpen=!0,this.activeItems=[...t];let n=t.filter(u=>!u.separator),a=t.findIndex(u=>!u.separator),r=t.length-1-[...t].reverse().findIndex(u=>!u.separator);t.forEach((u,x)=>{let b=document.createElement("div");if(u.separator){b.className="menu-separator",s.appendChild(b);return}if(b.className=`menu-item ${u.className||"highlights-dropdown-item"}`,x===a&&b.classList.add("first-menu-item"),x===r&&b.classList.add("last-menu-item"),n.length===1&&x===a&&b.classList.add("only-menu-item"),u.checked!==void 0){let w=document.createElement("div");w.className="highlights-dropdown-check",u.checked?((0,R.setIcon)(w,"check"),b.classList.add("is-checked")):u.uncheckedIcon&&(0,R.setIcon)(w,u.uncheckedIcon),b.appendChild(w);let H=u.id||`item-${x}`;this.checkboxElements.set(H,{element:b,checkDiv:w})}else if(u.icon){let w=document.createElement("div");w.className="menu-item-icon",(0,R.setIcon)(w,u.icon),b.appendChild(w)}let y=document.createElement("span");y.textContent=u.text,b.appendChild(y),b.addEventListener("click",w=>{if(w.preventDefault(),w.stopPropagation(),u.onClick&&u.onClick(),u.checked!==void 0){let H=u.id||`item-${x}`,k=!u.checked;this.activeItems[x].checked=k,this.updateCheckboxState(H,k),this.checkShouldAutoClose()}}),s.appendChild(b)}),document.body.appendChild(s);let l=s.getBoundingClientRect(),c=l.height,h=l.width,g=window.innerHeight,p=window.innerWidth,v=g-i.bottom,m=i.top,f,d;v>=c+8?(f=i.bottom+4,s.classList.add("dropdown-positioned-below")):m>=c+8?(f=i.top-c-4,s.classList.add("dropdown-positioned-above")):v>m?(f=i.bottom+4,s.classList.add("dropdown-positioned-below-constrained"),s.style.setProperty("--dropdown-max-height",`${v-8}px`),s.classList.add("dropdown-constrained-height")):(f=8,s.classList.add("dropdown-positioned-above-constrained"),s.style.setProperty("--dropdown-max-height",`${i.top-12}px`),s.classList.add("dropdown-constrained-height")),d=i.left,i.left+h>p-8&&(d=Math.max(8,i.right-h)),s.classList.add("dropdown-left-aligned"),s.style.setProperty("--dropdown-top",`${f}px`),s.style.setProperty("--dropdown-left",`${d}px`);let T=u=>{!s.contains(u.target)&&!o.contains(u.target)&&this.closeActiveDropdown()};this.documentClickHandlers.push(T),window.setTimeout(()=>{document.addEventListener("click",T)},100);let S=u=>{u.key==="Escape"&&this.closeActiveDropdown()};this.keydownHandlers.push(S),document.addEventListener("keydown",S)}updateCheckboxState(o,t){let e=this.checkboxElements.get(o);if(!e)return;let{element:i,checkDiv:s}=e,n=this.activeItems.find(a=>(a.id||`item-${this.activeItems.indexOf(a)}`)===o);t?((0,R.setIcon)(s,"check"),i.classList.add("is-checked")):(s.empty(),i.classList.remove("is-checked"),n&&n.uncheckedIcon&&(0,R.setIcon)(s,n.uncheckedIcon))}checkShouldAutoClose(){this.activeItems.some(t=>t.checked!==void 0&&t.checked===!0)||window.setTimeout(()=>{this.closeActiveDropdown()},100)}updateAllCheckboxStates(o){this.activeItems.forEach((t,e)=>{if(t.checked!==void 0){let i=t.id||`item-${e}`;o.hasOwnProperty(i)&&(t.checked=o[i],this.updateCheckboxState(i,o[i]))}}),this.checkShouldAutoClose()}cleanup(){this.closeActiveDropdown()}};var D=require("obsidian"),q=class{constructor(o){this.plugin=o}createFileContextMenu(o){let t=new D.Menu;return t.addItem(e=>{e.setTitle("Open in new tab").setIcon("lucide-plus").onClick(()=>{this.plugin.app.workspace.openLinkText(o.path,"","tab")})}),t.addItem(e=>{e.setTitle("Open to the right").setIcon("lucide-separator-vertical").onClick(()=>{this.plugin.app.workspace.openLinkText(o.path,"","split")})}),t.addSeparator(),t}createHighlightItem(o,t,e={}){let i=o.createDiv({cls:`highlight-item-card${this.plugin.selectedHighlightId===t.id?" selected":""}`,attr:{"data-highlight-id":t.id}});return this.applyHighlightStyling(i,t),this.createHoverColorPicker(i,t,e),this.createQuoteSection(i,t,e),this.createActionsSection(i,t,e),this.createCommentsSection(i,t,e),i}applyHighlightStyling(o,t){if(t.isNativeComment)o.classList.add("highlight-native-comment");else{let e=t.color||this.plugin.settings.highlightColor,i=this.getColorClassName(e);o.classList.add(i),i==="highlight-color-default"&&(o.classList.remove("highlight-color-default"),o.classList.add("highlight-color-custom"),o.style.setProperty("--highlight-color",e))}this.plugin.selectedHighlightId===t.id&&o.classList.add("highlight-selected")}getColorClassName(o){return{[this.plugin.settings.customColors.yellow]:"highlight-color-yellow",[this.plugin.settings.customColors.red]:"highlight-color-red",[this.plugin.settings.customColors.teal]:"highlight-color-teal",[this.plugin.settings.customColors.blue]:"highlight-color-blue",[this.plugin.settings.customColors.green]:"highlight-color-green"}[o]||"highlight-color-default"}createQuoteSection(o,t,e){let i=o.createDiv({cls:"highlight-quote"});this.renderMarkdownToElement(i,t.text),e.searchTerm&&e.searchTerm.length>0&&this.highlightSearchMatches(i,e.searchTerm),this.addTagsToQuote(i,t,e),i.addEventListener("click",s=>{var n;(n=e.onHighlightClick)==null||n.call(e,t,s)}),i.addEventListener("mouseover",s=>{this.plugin.app.workspace.trigger("hover-link",{event:s,source:"sidebar-highlights",hoverParent:i,targetEl:i,linktext:t.filePath,state:{scroll:t.startOffset}})})}addTagsToQuote(o,t,e){let i=this.extractTagsFromHighlight(t);if(i.length>0){let s=o.createDiv({cls:"highlight-tags"});i.forEach(n=>{s.createEl("span",{cls:"highlight-tag",text:n}).addEventListener("click",r=>{var l;r.stopPropagation(),(l=e.onTagClick)==null||l.call(e,n)})})}}createActionsSection(o,t,e){if(e.showHighlightActions===!1)return;let i=o.createDiv({cls:"highlight-actions"});this.addFileNameInfo(i,t,e);let s=i.createDiv({cls:"highlight-info-container"});this.addStatsInfo(s,t,e),this.addActionButtons(i,t,e)}addFileNameInfo(o,t,e){var i;if(e.showFilename){let s=((i=t.filePath.split("/").pop())==null?void 0:i.replace(/\.md$/,""))||t.filePath,n=o.createEl("small",{cls:"highlight-filename",text:s,attr:{title:t.filePath}});n.addEventListener("click",a=>{var r;a.stopPropagation(),(r=e.onFileNameClick)==null||r.call(e,t.filePath,a)}),n.addEventListener("contextmenu",a=>{a.preventDefault(),a.stopPropagation();let r=this.plugin.app.vault.getAbstractFileByPath(t.filePath);if(r instanceof D.TFile){let l=this.createFileContextMenu(r);this.plugin.app.workspace.trigger("file-menu",l,r,"sidebar-highlights"),l.showAtMouseEvent(a)}}),n.addEventListener("mouseover",a=>{this.plugin.app.workspace.trigger("hover-link",{event:a,source:"sidebar-highlights",hoverParent:n,targetEl:n,linktext:t.filePath})})}}addStatsInfo(o,t,e){var g;let i=t.line>=0?t.line+1:"Unknown",s=o.createDiv({cls:"highlight-info-line"}),n=s.createDiv({cls:"highlight-stats-section"});this.createInfoItem(n,"text",`${i}`,"highlight-line-info");let a=t.isNativeComment?0:((g=t.footnoteContents)==null?void 0:g.filter(p=>p.trim()!=="").length)||0,r=t.isNativeComment?"highlight-line-info highlight-comment-stat disabled":"highlight-line-info highlight-comment-stat clickable",l=this.createInfoItem(n,"message-square",`${a}`,r);t.isNativeComment||l.addEventListener("click",p=>{var v;p.stopPropagation(),(v=e.onCommentToggle)==null||v.call(e,t.id)});let c=this.plugin.collectionsManager.getHighlightCollectionCount(t.id);this.createInfoItem(n,"folder-open",`${c}`,"highlight-line-info highlight-collection-stat clickable").addEventListener("click",p=>{var v;p.stopPropagation(),(v=e.onCollectionsMenu)==null||v.call(e,p,t)}),this.addTimestampToInfoLine(s,t,e)}createInfoItem(o,t,e,i){let s=o.createDiv({cls:i}),n=s.createDiv({cls:t==="message-square"?"comment-icon":"line-icon"});return(0,D.setIcon)(n,t),s.createSpan({text:e}),s}addTimestampToInfoLine(o,t,e){if(e.showTimestamp&&t.createdAt){let i=(0,D.moment)(t.createdAt),s=e.dateFormat?i.format(e.dateFormat):i.format("YYYY-MM-DD HH:mm"),a=o.createDiv({cls:"highlight-timestamp-container"}).createDiv({cls:"highlight-timestamp-info",text:s,attr:{title:`Created: ${s}`}})}}addActionButtons(o,t,e){let i=o.createDiv({cls:"comment-buttons"})}createCommentsSection(o,t,e){var s;if(!e.isCommentsVisible)return;let i=o.createDiv({cls:"highlight-comments"});if(!t.isNativeComment){let n=((s=t.footnoteContents)==null?void 0:s.filter(a=>a.trim()!==""))||[];n.length>0&&n.forEach((a,r)=>{let l=i.createDiv({cls:"highlight-comment"});this.renderMarkdownToElement(l,a),l.addEventListener("click",c=>{var h;c.stopPropagation(),(h=e.onCommentClick)==null||h.call(e,t,r,c)})})}this.createAddCommentLine(i,t,e)}createAddCommentLine(o,t,e){let i=o.createDiv({cls:"highlight-add-comment-line"}),s=i.createDiv({cls:"highlight-add-comment-icon"});(0,D.setIcon)(s,"plus"),i.createSpan({text:"Add comment"}),i.addEventListener("click",n=>{var a;n.stopPropagation(),(a=e.onAddComment)==null||a.call(e,t)})}highlightSearchMatches(o,t){if(!t)return;let e=t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),i=new RegExp(e,"gi"),s=document.createTreeWalker(o,NodeFilter.SHOW_TEXT,null),n,a=[];for(;n=s.nextNode();)n.nodeValue&&n.nodeValue.trim()!==""&&!(n.parentElement&&n.parentElement.classList.contains("search-term-highlight"))&&a.push(n);a.forEach(r=>{let l=r.nodeValue,c=[],h=0,g;for(;(g=i.exec(l))!==null;){g.index>h&&c.push(document.createTextNode(l.substring(h,g.index)));let p=document.createElement("span");p.className="search-term-highlight",p.textContent=g[0],c.push(p),h=i.lastIndex}h<l.length&&c.push(document.createTextNode(l.substring(h))),c.length>0&&r.parentNode&&(c.forEach(p=>r.parentNode.insertBefore(p,r)),r.parentNode.removeChild(r))})}renderMarkdownToElement(o,t){o.empty();let e=this.parseMarkdownSegments(t);for(let i of e)if(i.type==="text")o.appendText(i.content||"");else if(i.type==="strong"){let s=o.createEl("strong");s.textContent=i.content||""}else if(i.type==="em"){let s=o.createEl("em");s.textContent=i.content||""}else if(i.type==="code"){let s=o.createEl("code");s.textContent=i.content||""}else if(i.type==="del"){let s=o.createEl("del");s.textContent=i.content||""}else if(i.type==="link"){let s=o.createEl("a");s.textContent=i.text||"",s.href=i.url||"",s.target="_blank"}}parseMarkdownSegments(o){let t=[],e=[{regex:/\*\*(.*?)\*\*/g,type:"strong"},{regex:/__(.*?)__/g,type:"strong"},{regex:/~~(.*?)~~/g,type:"del"},{regex:/`([^`]+?)`/g,type:"code"},{regex:/\[([^\]]+)\]\(([^)]+)\)/g,type:"link"}],i=[];for(let a of e){let r;for(a.regex.lastIndex=0;(r=a.regex.exec(o))!==null;)a.type==="link"?i.push({start:r.index,end:r.index+r[0].length,type:a.type,text:r[1],url:r[2]}):i.push({start:r.index,end:r.index+r[0].length,type:a.type,content:r[1]})}this.findItalicMatches(o,i),i.sort((a,r)=>a.start-r.start);let s=[];for(let a of i)s.some(r=>a.start>=r.start&&a.start<r.end||a.end>r.start&&a.end<=r.end)||s.push(a);let n=0;for(let a of s)n<a.start&&t.push({type:"text",content:o.substring(n,a.start)}),t.push(a),n=a.end;return n<o.length&&t.push({type:"text",content:o.substring(n)}),t}findItalicMatches(o,t){for(let e=0;e<o.length;e++)if(o[e]==="*"&&(e===0||o[e-1]!=="*")&&(e===o.length-1||o[e+1]!=="*")){for(let i=e+1;i<o.length;i++)if(o[i]==="*"&&(i===o.length-1||o[i+1]!=="*")&&(i===0||o[i-1]!=="*")){let s=o.substring(e+1,i);if(s.length>0&&s.indexOf("*")===-1){t.push({start:e,end:i+1,type:"em",content:s}),e=i;break}}}for(let e=0;e<o.length;e++)if(o[e]==="_"&&(e===0||o[e-1]!=="_")&&(e===o.length-1||o[e+1]!=="_")){for(let i=e+1;i<o.length;i++)if(o[i]==="_"&&(i===o.length-1||o[i+1]!=="_")&&(i===0||o[i-1]!=="_")){let s=o.substring(e+1,i);if(s.length>0&&s.indexOf("_")===-1){t.push({start:e,end:i+1,type:"em",content:s}),e=i;break}}}}extractTagsFromHighlight(o){let t=[];if(o.footnoteContents){for(let e of o.footnoteContents)if(e.trim()!==""){let i=e.match(/#[\p{L}\p{N}\p{M}_/-]+/gu);i&&i.forEach(s=>{let n=s.substring(1);t.includes(n)||t.push(n)})}}return t}isColorChangeable(o){return!o.isNativeComment&&!this.isHtmlHighlight(o)}isHtmlHighlight(o){return!o.isNativeComment&&!!o.color}createHoverColorPicker(o,t,e){if(!this.isColorChangeable(t))return;let i=o.createDiv({cls:"highlight-border-hover-zone"}),s=o.createDiv({cls:"hover-color-picker"}),n=s.createDiv({cls:"hover-color-options"});[this.plugin.settings.customColors.yellow,this.plugin.settings.customColors.red,this.plugin.settings.customColors.teal,this.plugin.settings.customColors.blue,this.plugin.settings.customColors.green].forEach((h,g)=>{n.createDiv({cls:"hover-color-option",attr:{"data-color":h,style:`--option-index: ${g}`}}).addEventListener("click",v=>{var m;v.stopPropagation(),(m=e.onColorChange)==null||m.call(e,t,h)})});let r,l=()=>{r=window.setTimeout(()=>{s.classList.add("visible")},500)},c=()=>{window.clearTimeout(r),s.classList.remove("visible")};i.addEventListener("mouseenter",l),i.addEventListener("mouseleave",c),s.addEventListener("mouseenter",()=>{window.clearTimeout(r),s.classList.add("visible")}),s.addEventListener("mouseleave",c)}};var B=class{isHtmlHighlight(o){return!o.isNativeComment&&!!o.color}getHtmlHighlightPatterns(o){let t=this.escapeRegex(o.text),e=[];return e.push({pattern:`<span\\s+style=["'][^"']*background:\\s*[^;"']+[^"']*["'][^>]*>${t}<\\/span>`}),e.push({pattern:`<font\\s+color=["'][^"']+["'][^>]*>${t}<\\/font>`}),e.push({pattern:`<mark[^>]*>${t}<\\/mark>`}),e}extractInlineFootnotes(o,t){let e=[],i=o.substring(t),s=/(\s*\^\[([^\]]+)\])/g,n;for(;(n=s.exec(i))!==null&&(n.index===0||this.isValidFootnotePosition(i,n.index));)e.push({content:n[2],startIndex:t+n.index,endIndex:t+n.index+n[0].length});return e}isValidFootnotePosition(o,t){let e=o.substring(0,t);return/^(\s*(\[\^[a-zA-Z0-9_-]+\]|\^\[[^\]]+\])\s*)*\s*$/.test(e)}insertInlineFootnote(o,t,e){let i=o.getValue(),s=this.escapeRegex(t.text),n=null,a=1/0;if(t.isNativeComment){let v=`%%${s}%%`,m=new RegExp(v,"g"),f;for(;(f=m.exec(i))!==null;){let d=Math.abs(f.index-t.startOffset);d<a&&(a=d,n={index:f.index,length:f[0].length})}}else if(this.isHtmlHighlight(t)){let v=this.getHtmlHighlightPatterns(t);for(let{pattern:m}of v){let f=new RegExp(m,"gi"),d;for(;(d=f.exec(i))!==null;){let T=Math.abs(d.index-t.startOffset);T<a&&(a=T,n={index:d.index,length:d[0].length})}}}else{let v=`==${s}==`,m=new RegExp(v,"g"),f;for(;(f=m.exec(i))!==null;){let d=Math.abs(f.index-t.startOffset);d<a&&(a=d,n={index:f.index,length:f[0].length})}}if(!n)return!1;let r=n.index+n.length,l=i.substring(r),c=l.match(/^(\s*(\[\^[a-zA-Z0-9_-]+\]|\^\[[^\]]+\]))*/),h=c?c[0].length:0;if(h>0&&l.length>h){let v=l.substring(h);if(!v.match(/^\S/)){let m=v.match(/^(\s+)/);if(m){let f=m[1];v.substring(m[0].length).length===0&&(h+=m[0].length)}}}else if(h>0){let v=l.substring(h).match(/^\s+/);v&&(h+=v[0].length)}r+=h;let g=`^[${e}]`,p=o.offsetToPos(r);if(o.replaceRange(g,p),e.length>0){let v=o.offsetToPos(r+g.indexOf(e)),m=o.offsetToPos(r+g.indexOf(e)+e.length);o.setSelection(v,m)}else{let v=o.offsetToPos(r+g.length-1);o.setCursor(v)}return o.focus(),!0}escapeRegex(o){return o.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}};var A=class{static parseQuery(o){if(!o.trim())return{ast:null};try{return this.tokens=this.tokenize(o),this.position=0,this.depth=0,{ast:this.parseExpression()}}catch(t){return console.warn("Search parsing error:",t),{ast:null}}}static tokenize(o){let t=[],e=0,i=0,s=o.length*2;for(;e<o.length&&i<s;){if(i++,/\s/.test(o[e])){e++;continue}if(o[e]==="("){t.push({type:"LPAREN",value:"("}),e++;continue}if(o[e]===")"){t.push({type:"RPAREN",value:")"}),e++;continue}if(o.substr(e,3)==="AND"&&(e+3>=o.length||/\s/.test(o[e+3]))){t.push({type:"AND",value:"AND"}),e+=3;continue}if(o.substr(e,2)==="OR"&&(e+2>=o.length||/\s/.test(o[e+2]))){t.push({type:"OR",value:"OR"}),e+=2;continue}if(o[e]==='"'){e++;let l=e;for(;e<o.length&&o[e]!=='"';)e++;if(e<o.length){let c=o.substring(l,e);c.trim()&&t.push({type:"TEXT",value:c}),e++}else{let c=o.substring(l-1);t.push({type:"TEXT",value:c}),e=o.length}continue}let n=o.substr(e).match(/^(-?)([#@])([a-zA-Z0-9_/-]+)/);if(n){let l=n[1]==="-",c=n[2],h=n[3];t.push({type:"FILTER",value:h,filterType:c==="#"?"tag":"collection",exclude:l}),e+=n[0].length;continue}let a=e,r="";for(;e<o.length&&!(o.substr(e,3)==="AND"&&(e+3>=o.length||/\s/.test(o[e+3]))||o.substr(e,2)==="OR"&&(e+2>=o.length||/\s/.test(o[e+2]))||o[e]==="("||o[e]===")"||o[e]==='"'||o.substr(e).match(/^(-?)([#@])([a-zA-Z0-9_-]+)/));)r+=o[e],e++;r=r.trim(),r?t.push({type:"TEXT",value:r}):e===a&&e++}return t}static parseExpression(){var e;if(++this.depth>this.MAX_DEPTH)throw new Error("Maximum parsing depth exceeded");let o=this.parseAndExpression(),t=0;for(;((e=this.current())==null?void 0:e.type)==="OR"&&t<100;){this.advance();let i=this.parseAndExpression();if(!i)break;o={type:"operator",operator:"OR",left:o,right:i},t++}return this.depth--,o}static parseAndExpression(){var e,i;if(++this.depth>this.MAX_DEPTH)throw new Error("Maximum parsing depth exceeded");let o=this.parsePrimary(),t=0;for(;(((e=this.current())==null?void 0:e.type)==="AND"||this.isImplicitAnd())&&t<100;){((i=this.current())==null?void 0:i.type)==="AND"&&this.advance();let s=this.parsePrimary();if(!s)break;o={type:"operator",operator:"AND",left:o,right:s},t++}return this.depth--,o}static parsePrimary(){var t;if(++this.depth>this.MAX_DEPTH)throw new Error("Maximum parsing depth exceeded");let o=this.current();if(!o)return this.depth--,null;if(o.type==="LPAREN"){this.advance();let e=this.parseExpression();return((t=this.current())==null?void 0:t.type)==="RPAREN"&&this.advance(),this.depth--,e}if(o.type==="FILTER"){this.advance();let e={type:"filter",filterType:o.filterType,value:o.value,exclude:o.exclude||!1};return this.depth--,e}if(o.type==="TEXT"){this.advance();let e={type:"text",value:o.value};return this.depth--,e}return this.depth--,null}static current(){return this.tokens[this.position]}static advance(){this.position++}static isImplicitAnd(){let o=this.current();return!!o&&(o.type==="FILTER"||o.type==="TEXT"||o.type==="LPAREN")}static getTokensFromQuery(o){let t=[],e=this.parseQuery(o);return e.ast&&this.extractTokensFromAST(e.ast,t),t}static extractTokensFromAST(o,t){if(o.type==="filter"){let e=o;t.push({type:e.filterType,value:e.value,exclude:e.exclude})}else if(o.type==="text"){let e=o;t.push({type:"text",value:e.value,exclude:!1})}else if(o.type==="operator"){let e=o;this.extractTokensFromAST(e.left,t),this.extractTokensFromAST(e.right,t)}}};A.tokens=[],A.position=0,A.depth=0,A.MAX_DEPTH=50;var U=class{constructor(o,t,e,i){this.currentSuggestions=[];this.selectedIndex=-1;this.input=o,this.container=t,this.onSearchChange=e,this.suggestions=i,this.createDropdown(),this.createPreview(),this.setupEventListeners()}createDropdown(){this.dropdown=this.container.createDiv({cls:"simple-search-dropdown"}),this.dropdown.classList.add("hidden")}createPreview(){this.previewElement=this.container.createDiv({cls:"simple-search-preview"}),this.previewElement.classList.add("hidden")}setupEventListeners(){this.input.addEventListener("input",()=>{this.handleInput()}),this.input.addEventListener("keydown",o=>{this.handleKeydown(o)}),this.input.addEventListener("focus",()=>{this.updateAutocomplete()}),this.input.addEventListener("blur",()=>{window.setTimeout(()=>this.hideDropdown(),150)})}handleInput(){let o=this.input.value,t=A.parseQuery(o);this.updatePreview(t),this.updateAutocomplete(),this.onSearchChange(o,t)}handleKeydown(o){if(!this.dropdown.classList.contains("hidden"))switch(o.key){case"ArrowDown":o.preventDefault(),this.selectNext();break;case"ArrowUp":o.preventDefault(),this.selectPrevious();break;case"Enter":o.preventDefault(),this.applySuggestion();break;case"Escape":o.preventDefault(),this.hideDropdown();break}}updateAutocomplete(){let o=this.input.value,t=this.input.selectionStart||0,e=o.substring(0,t),i=e.match(/-?#([a-zA-Z0-9_/-]*)$/),s=e.match(/-?@([a-zA-Z0-9_-]*)$/);i?this.showSuggestions("tag",i[1],i[0].startsWith("-")):s?this.showSuggestions("collection",s[1],s[0].startsWith("-")):this.hideDropdown()}showSuggestions(o,t,e){let i=o==="tag"?this.suggestions.tags:this.suggestions.collections;if(this.currentSuggestions=i.filter(s=>s.toLowerCase().includes(t.toLowerCase())).slice(0,8),this.dropdown.empty(),this.selectedIndex=-1,this.currentSuggestions.length===0){this.hideDropdown();return}this.currentSuggestions.forEach((s,n)=>{let a=this.dropdown.createDiv({cls:"simple-search-suggestion"}),r=a.createSpan({cls:"simple-search-suggestion-icon",text:o==="tag"?"#":"@"});e&&r.classList.add("exclude");let l=this.formatNestedTag(s);a.createSpan({cls:"simple-search-suggestion-text",text:l}),a.addEventListener("click",()=>{this.selectedIndex=n,this.applySuggestion()}),a.addEventListener("mouseenter",()=>{this.setSelected(n)})}),this.dropdown.classList.remove("hidden")}selectNext(){this.currentSuggestions.length!==0&&this.setSelected((this.selectedIndex+1)%this.currentSuggestions.length)}selectPrevious(){this.currentSuggestions.length!==0&&this.setSelected(this.selectedIndex<=0?this.currentSuggestions.length-1:this.selectedIndex-1)}setSelected(o){let t=this.dropdown.querySelectorAll(".simple-search-suggestion");t.forEach(e=>e.classList.remove("selected")),o>=0&&o<t.length&&(t[o].classList.add("selected"),this.selectedIndex=o)}applySuggestion(){if(this.selectedIndex<0||this.selectedIndex>=this.currentSuggestions.length)return;let o=this.currentSuggestions[this.selectedIndex],t=this.input.value,e=this.input.selectionStart||0,i=t.substring(0,e),s=t.substring(e),n=i.match(/-?#([a-zA-Z0-9_-]*)$/),a=i.match(/-?@([a-zA-Z0-9_-]*)$/),r,l;if(n){let h=(n[0].startsWith("-")?"-#":"#")+o+" ";r=i.replace(/-?#[a-zA-Z0-9_/-]*$/,h)+s,l=i.replace(/-?#[a-zA-Z0-9_/-]*$/,h).length}else if(a){let h=(a[0].startsWith("-")?"-@":"@")+o+" ";r=i.replace(/-?@[a-zA-Z0-9_-]*$/,h)+s,l=i.replace(/-?@[a-zA-Z0-9_-]*$/,h).length}else return;this.input.value=r,this.input.setSelectionRange(l,l),this.hideDropdown(),this.handleInput()}hideDropdown(){this.dropdown.classList.add("hidden"),this.selectedIndex=-1}updatePreview(o){if(this.previewElement.empty(),!this.input.value.trim()){this.previewElement.classList.add("hidden");return}if(this.previewElement.classList.remove("hidden"),!o.ast){this.previewElement.createSpan({cls:"simple-search-preview-text",text:"Use #tag @collection (-# to exclude)"});return}let t=o.ast?this.generateDescription(o.ast):"Invalid search query";this.previewElement.createSpan({cls:"simple-search-preview-label",text:"Matching: "}),this.previewElement.createSpan({cls:"simple-search-preview-logic",text:t})}generateDescription(o){return o?this.generateNodeDescription(o):"Invalid"}generateNodeDescription(o){if(o.type==="filter"){let t=o,e=t.exclude?"-":"",i=t.filterType==="tag"?"#":"@";return`${e}${i}${t.value}`}else{if(o.type==="text")return`"${o.value}"`;if(o.type==="operator"){let t=o,e=this.generateNodeDescription(t.left),i=this.generateNodeDescription(t.right);return`${e} ${t.operator} ${i}`}}return""}updateSuggestions(o){this.suggestions=o,this.updateAutocomplete()}clear(){this.input.value="",this.hideDropdown(),this.handleInput()}setValue(o){this.input.value=o,this.handleInput()}formatNestedTag(o){return o}};var ut="highlights-sidebar",Y=class extends C.ItemView{constructor(t,e){super(t);this.highlightCommentsVisible=new Map;this.groupingMode="none";this.commentsExpanded=!1;this.selectedTags=new Set;this.selectedCollections=new Set;this.viewMode="current";this.currentCollectionId=null;this.preservedScrollTop=0;this.isHighlightFocusing=!1;this.currentPage=0;this.itemsPerPage=100;this.totalHighlights=[];this.isPreservingPagination=!1;this.currentGroupPage=0;this.totalGroups=[];this.isColorChanging=!1;this.searchExpanded=!1;this.currentSearchTokens=[];this.currentParsedSearch={ast:null};this.dropdownManager=new z;this.savedScrollPosition=0;this.showNativeComments=!0;this.plugin=e,this.highlightRenderer=new q(e),this.groupingMode=e.settings.groupingMode||"none",this.showNativeComments=this.plugin.app.loadLocalStorage("sidebar-highlights-show-native-comments")!=="false"}getViewType(){return ut}getDisplayText(){return"Highlights"}getIcon(){return"highlighter"}async onOpen(){if(this.contentEl.empty(),this.contentEl.classList.add("highlights-sidebar-content"),this.plugin.settings.showToolbar){let n=this.contentEl.createDiv({cls:"highlights-search-container"}),a=n.createEl("button",{cls:"highlights-group-button"});this.searchButton=a,(0,C.setIcon)(a,"search"),(0,C.setTooltip)(a,"Search"),a.addEventListener("click",()=>{this.toggleSearch()});let r=n.createEl("button",{cls:"highlights-group-button"});(0,C.setIcon)(r,"group"),(0,C.setTooltip)(r,"Group highlights"),this.updateGroupButtonState(r),r.addEventListener("click",m=>{let f=new C.Menu;f.addItem(d=>{d.setTitle("None").setIcon("list").setChecked(this.groupingMode==="none").onClick(()=>{this.groupingMode="none",this.updateGroupButtonState(r),this.saveGroupingModeToSettings(),this.renderContent()})}),f.addSeparator(),f.addItem(d=>{d.setTitle("Color").setIcon("palette").setChecked(this.groupingMode==="color").onClick(()=>{this.groupingMode="color",this.updateGroupButtonState(r),this.saveGroupingModeToSettings(),this.renderContent()})}),f.addSeparator(),f.addItem(d=>{d.setTitle("Highlight comments \u2191").setIcon("sort-asc").setChecked(this.groupingMode==="comments-asc").onClick(()=>{this.groupingMode="comments-asc",this.updateGroupButtonState(r),this.saveGroupingModeToSettings(),this.renderContent()})}),f.addItem(d=>{d.setTitle("Highlight comments \u2193").setIcon("sort-desc").setChecked(this.groupingMode==="comments-desc").onClick(()=>{this.groupingMode="comments-desc",this.updateGroupButtonState(r),this.saveGroupingModeToSettings(),this.renderContent()})}),f.addSeparator(),f.addItem(d=>{d.setTitle("Date created \u2191").setIcon("calendar").setChecked(this.groupingMode==="date-created-asc").onClick(()=>{this.groupingMode="date-created-asc",this.updateGroupButtonState(r),this.saveGroupingModeToSettings(),this.renderContent()})}),f.addItem(d=>{d.setTitle("Date created \u2193").setIcon("calendar").setChecked(this.groupingMode==="date-created-desc").onClick(()=>{this.groupingMode="date-created-desc",this.updateGroupButtonState(r),this.saveGroupingModeToSettings(),this.renderContent()})}),f.addSeparator(),f.addItem(d=>{d.setTitle("Parent").setIcon("folder").setChecked(this.groupingMode==="parent").onClick(()=>{this.groupingMode="parent",this.updateGroupButtonState(r),this.saveGroupingModeToSettings(),this.renderContent()})}),f.addItem(d=>{d.setTitle("Collection").setIcon("folder-open").setChecked(this.groupingMode==="collection").onClick(()=>{this.groupingMode="collection",this.updateGroupButtonState(r),this.saveGroupingModeToSettings(),this.renderContent()})}),f.addItem(d=>{d.setTitle("Filename").setIcon("file-text").setChecked(this.groupingMode==="filename").onClick(()=>{this.groupingMode="filename",this.updateGroupButtonState(r),this.saveGroupingModeToSettings(),this.renderContent()})}),f.showAtMouseEvent(m)});let l=n.createEl("button",{cls:"highlights-group-button"});(0,C.setTooltip)(l,"Toggle native comments"),this.updateNativeCommentsToggleState(l),l.addEventListener("click",()=>{this.toggleNativeCommentsVisibility(),this.updateNativeCommentsToggleState(l),this.renderContent()});let c=n.createEl("button",{cls:"highlights-group-button"});(0,C.setTooltip)(c,"Toggle highlight comments"),this.commentsToggleButton=c,this.updateCommentsToggleIcon(c),c.addEventListener("click",()=>{this.toggleAllComments(),this.updateCommentsToggleIcon(c),this.renderContent()});let h=n.createEl("button",{cls:"highlights-group-button"});(0,C.setTooltip)(h,"Revert highlight colors"),(0,C.setIcon)(h,"rotate-ccw"),h.addEventListener("click",()=>{this.resetAllColors()});let g=n.createEl("button",{cls:"highlights-group-button highlights-tag-filter-button"});(0,C.setTooltip)(g,"Filter"),(0,C.setIcon)(g,"list-filter"),g.addEventListener("click",m=>{this.showTagFilterMenu(m)});let p=n.createEl("button",{cls:"highlights-group-button"});(0,C.setTooltip)(p,"Collection Navigation"),this.updateCollectionNavButton(p),p.addEventListener("click",()=>{this.viewMode==="collections"&&this.currentCollectionId?(this.currentCollectionId=null,this.renderContent()):this.showNewCollectionDialog()});let v=this.contentEl.createDiv({cls:"highlights-search-input-container hidden"});this.searchInputEl=v.createEl("input",{type:"text",placeholder:"Search highlights, use #tag @collection (-# to exclude)...",cls:"highlights-search-input"}),this.simpleSearchManager=new U(this.searchInputEl,v,(m,f)=>this.handleSearchInput(m,f),{tags:this.getAvailableTags(),collections:this.getAvailableCollections()})}let t=this.contentEl.createDiv({cls:"highlights-tabs-container"}),e=t.createEl("button",{cls:"highlights-tab active"});(0,C.setIcon)(e,"file-text"),(0,C.setTooltip)(e,"Current note");let i=t.createEl("button",{cls:"highlights-tab"});(0,C.setIcon)(i,"files"),(0,C.setTooltip)(i,"All notes");let s=t.createEl("button",{cls:"highlights-tab"});(0,C.setIcon)(s,"folder-open"),(0,C.setTooltip)(s,"Collections"),e.addEventListener("click",()=>{this.viewMode!=="current"&&(e.classList.add("active"),i.classList.remove("active"),s.classList.remove("active"),this.viewMode="current",this.selectedTags.clear(),this.selectedCollections.clear(),this.updateContent())}),i.addEventListener("click",()=>{this.viewMode!=="all"&&(i.classList.add("active"),e.classList.remove("active"),s.classList.remove("active"),this.viewMode="all",this.selectedTags.clear(),this.selectedCollections.clear(),this.updateContent())}),s.addEventListener("click",()=>{this.viewMode!=="collections"&&(s.classList.add("active"),e.classList.remove("active"),i.classList.remove("active"),this.viewMode="collections",this.currentCollectionId=null,this.selectedTags.clear(),this.selectedCollections.clear(),this.updateContent())}),this.contentAreaEl=this.contentEl.createDiv({cls:"highlights-list-area"}),this.listContainerEl=this.contentAreaEl.createDiv({cls:"highlights-list"}),this.renderContent()}async onClose(){this.dropdownManager.cleanup(),this.highlightCommentsVisible.clear(),this.selectedTags.clear()}navigateToCollection(t){if(!this.plugin.collectionsManager.getCollection(t)){new C.Notice("Collection not found");return}this.viewMode="collections",this.currentCollectionId=t;let i=this.contentEl.querySelectorAll(".highlights-tab");if(i.length>=3){let s=i[0],n=i[1],a=i[2];s.classList.remove("active"),n.classList.remove("active"),a.classList.remove("active"),a.classList.add("active")}this.selectedTags.clear(),this.renderContent()}refresh(){this.selectedTags.clear();let t=this.viewMode,e=this.currentCollectionId,i=this.isHighlightFocusing||this.isColorChanging,s=this.preservedScrollTop;i||this.captureScrollPosition(),this.onOpen(),this.viewMode=t,this.currentCollectionId=e,this.updateTabStates(),this.restoreSelectedHighlight(),i?requestAnimationFrame(()=>{this.contentAreaEl&&(this.contentAreaEl.scrollTop=s)}):this.restoreScrollPosition()}updateTabStates(){let t=this.contentEl.querySelectorAll(".highlights-tab");if(t.length>=3){let e=t[0],i=t[1],s=t[2];switch(e.classList.remove("active"),i.classList.remove("active"),s.classList.remove("active"),this.viewMode){case"current":e.classList.add("active");break;case"all":i.classList.add("active");break;case"collections":s.classList.add("active");break}}}captureScrollPosition(){this.contentAreaEl&&(this.savedScrollPosition=this.contentAreaEl.scrollTop)}restoreScrollPosition(){this.contentAreaEl&&!this.isHighlightFocusing&&!this.isColorChanging&&requestAnimationFrame(()=>{this.contentAreaEl.scrollTop=this.savedScrollPosition})}restoreSelectedHighlight(){this.plugin.selectedHighlightId&&requestAnimationFrame(()=>{this.containerEl.querySelectorAll(".selected, .highlight-selected").forEach(i=>{i.classList.remove("selected","highlight-selected"),i.style.removeProperty("border-left-color"),i.style.removeProperty("box-shadow")});let e=this.containerEl.querySelector(`[data-highlight-id="${this.plugin.selectedHighlightId}"]`);if(e){e.classList.add("selected");let i=this.plugin.selectedHighlightId?this.getHighlightById(this.plugin.selectedHighlightId):null;i&&(e.classList.add("highlight-selected"),this.applyHighlightColorStyling(e,i))}})}applyHighlightColorStyling(t,e){let i=e.color||this.plugin.settings.highlightColor;t.style.borderLeftColor=i,e.isNativeComment||(t.style.boxShadow=`0 0 0 1.5px ${i}, var(--shadow-s)`)}updateContent(){this.renderContent()}updateItem(t){var r;let e=this.containerEl.querySelector(`[data-highlight-id="${t}"]`);if(!e)return;let i=this.getHighlightById(t);if(!i){e.remove();return}let s=document.createElement("div"),n=this.viewMode==="all";this.createHighlightItem(s,i,this.getSearchTerm(),n);let a=s.firstElementChild;a&&((r=e.parentNode)==null||r.replaceChild(a,e),this.plugin.selectedHighlightId===t&&(a.classList.add("selected"),a.classList.add("highlight-selected"),this.applyHighlightColorStyling(a,i)))}getSearchTerm(){let t=this.containerEl.querySelector(".highlights-search-input");return(t==null?void 0:t.value)||""}renderContent(){this.captureScrollPosition(),this.viewMode==="collections"?this.currentCollectionId?(this.enableSearchAndToolbar(),this.renderCollectionDetailView(this.currentCollectionId)):(this.disableSearchAndToolbar(),this.renderCollectionsView()):(this.enableSearchAndToolbar(),this.renderFilteredList());let t=this.contentEl.querySelector(".highlights-search-container button:last-of-type");t&&this.updateCollectionNavButton(t),this.restoreScrollPosition()}renderCollectionsView(){this.captureScrollPosition(),this.contentAreaEl.empty(),this.listContainerEl=this.contentAreaEl.createDiv({cls:"highlights-list collections-container"});let t=this.plugin.collectionsManager.getAllCollections();t.length===0?this.renderEmptyCollectionsState(this.listContainerEl):this.renderCollectionsGrid(this.listContainerEl,t),this.restoreScrollPosition()}renderEmptyCollectionsState(t){t.createEl("p",{text:"No collections."})}renderCollectionsGrid(t,e){let i=t.createDiv({cls:"collections-grid"});e.forEach(s=>{let n=i.createDiv({cls:"collection-card"});n.setAttribute("data-collection-id",s.id);let a=n.createDiv({cls:"collection-menu-btn"});(0,C.setIcon)(a,"ellipsis-vertical"),a.addEventListener("click",d=>{d.stopPropagation(),this.showCollectionMenu(d,s)});let r=n.createDiv({cls:"collection-name"});r.textContent=s.name;let l=n.createDiv({cls:"collection-description"});s.description&&s.description.trim()?l.textContent=s.description:(l.textContent="No description",l.classList.add("collection-description-empty"));let c=n.createDiv({cls:"collection-stats"}),h=this.plugin.collectionsManager.getCollectionStats(s.id),g=c.createEl("small",{cls:"collection-info-line"}),p=g.createDiv({cls:"highlight-line-info"}),v=p.createDiv({cls:"line-icon"});if((0,C.setIcon)(v,"highlighter"),p.createSpan({text:`${h.highlightCount}`}),this.showNativeComments){let d=g.createDiv({cls:"highlight-line-info"}),T=d.createDiv({cls:"line-icon"});(0,C.setIcon)(T,"captions"),d.createSpan({text:`${h.nativeCommentsCount}`})}let m=g.createDiv({cls:"highlight-line-info"}),f=m.createDiv({cls:"line-icon"});(0,C.setIcon)(f,"file-text"),m.createSpan({text:`${h.fileCount}`}),n.addEventListener("click",()=>{this.currentCollectionId=s.id,this.renderContent()})})}renderCollectionDetailView(t){this.captureScrollPosition();let e=this.plugin.collectionsManager.getCollection(t);if(!e){new C.Notice("Collection not found"),this.currentCollectionId=null,this.renderContent();return}this.contentAreaEl.empty(),this.listContainerEl=this.contentAreaEl.createDiv({cls:"highlights-list"});let i=this.plugin.collectionsManager.getHighlightsInCollection(t);i.length===0?this.renderEmptyCollectionState(this.listContainerEl,e):this.renderCollectionHighlights(i),this.restoreScrollPosition()}renderEmptyCollectionState(t,e){t.createEl("p",{text:"No highlights in collection."})}renderCollectionHighlights(t){var s;let e=((s=this.searchInputEl)==null?void 0:s.value.toLowerCase().trim())||"",i=this.applyAllFilters(t);if(i.length===0){let n=e?"No matching highlights in collection.":"No highlights in collection.";this.listContainerEl.createEl("p",{text:n});return}this.groupingMode==="none"?i.sort((a,r)=>a.filePath!==r.filePath?a.filePath.localeCompare(r.filePath):a.startOffset-r.startOffset).forEach(a=>{this.createHighlightItem(this.listContainerEl,a,e,!0)}):this.renderGroupedHighlights(i,e,!0)}renderFilteredList(){if(!this.contentAreaEl||!this.listContainerEl)return;this.captureScrollPosition(),this.contentAreaEl.empty(),this.listContainerEl=this.contentAreaEl.createDiv({cls:"highlights-list"});let t=this.searchInputEl?this.searchInputEl.value.toLowerCase().trim():"";this.listContainerEl.empty();let e;if(this.viewMode==="current"){if(!this.plugin.app.workspace.getActiveFile()){this.listContainerEl.createEl("p",{text:"No file open."}),this.restoreScrollPosition(),this.showTagActive();return}e=this.plugin.getCurrentFileHighlights()}else if(this.viewMode==="all"){e=[];for(let[s,n]of this.plugin.highlights)e.push(...n)}else return;let i=this.applyAllFilters(e);if(i.length===0){let s;if(this.viewMode==="current"){let n=this.plugin.app.workspace.getActiveFile();n&&n.extension==="pdf"?s="PDF highlights are not supported.":s=t?"No matching highlights.":"No highlights in this file."}else s=t?"No matching highlights across all files.":"No highlights found across all files.";this.listContainerEl.createEl("p",{text:s})}else if(this.groupingMode==="none"){let s=i.sort((n,a)=>n.filePath!==a.filePath?n.filePath.localeCompare(a.filePath):n.startOffset-a.startOffset);this.viewMode==="all"?this.renderHighlightsWithPagination(s,t):s.forEach(n=>{this.createHighlightItem(this.listContainerEl,n,t,!1)})}else this.viewMode==="all"?this.renderGroupedHighlightsWithPagination(i,t):this.renderGroupedHighlights(i,t,!1);this.showTagActive(),this.restoreScrollPosition()}renderHighlightsWithPagination(t,e){this.totalHighlights=t,this.isPreservingPagination||(this.currentPage=0);let i=Math.max(0,Math.ceil(t.length/this.itemsPerPage)-1);this.currentPage>i&&(this.currentPage=i),this.renderCurrentPage(e),this.renderPaginationControls(),this.isPreservingPagination=!1}renderCurrentPage(t){let e=this.currentPage*this.itemsPerPage,i=Math.min(e+this.itemsPerPage,this.totalHighlights.length),s=this.totalHighlights.slice(e,i);this.listContainerEl.empty(),s.forEach(n=>{this.createHighlightItem(this.listContainerEl,n,t,!0)})}renderPaginationControls(){let t=this.listContainerEl.querySelector(".pagination-controls");t&&t.remove();let e=Math.ceil(this.totalHighlights.length/this.itemsPerPage);if(e<=1)return;let i=this.listContainerEl.createDiv({cls:"pagination-controls"}),s=i.createEl("button",{cls:"clickable-icon"});s.disabled=this.currentPage===0,(0,C.setIcon)(s,"chevron-left"),s.addEventListener("click",()=>{this.currentPage>0&&(this.currentPage--,this.renderCurrentPage(this.getSearchTerm()),this.renderPaginationControls(),requestAnimationFrame(()=>{this.contentAreaEl.scrollTop=0}))});let n=i.createSpan({text:`${this.currentPage+1}/${e}`,cls:"pagination-info pagination-info-compact"}),a=i.createEl("button",{cls:"clickable-icon"});a.disabled=this.currentPage>=e-1,(0,C.setIcon)(a,"chevron-right"),a.addEventListener("click",()=>{this.currentPage<e-1&&(this.currentPage++,this.renderCurrentPage(this.getSearchTerm()),this.renderPaginationControls(),requestAnimationFrame(()=>{this.contentAreaEl.scrollTop=0}))})}renderGroupedHighlightsWithPagination(t,e){let i=new Map,s=new Map;t.forEach(l=>{var h;let c;if(this.groupingMode==="color"){let g=l.color||this.plugin.settings.highlightColor;c=g,s.set(c,g)}else if(this.groupingMode==="comments-asc"||this.groupingMode==="comments-desc"){let g=l.isNativeComment?0:((h=l.footnoteContents)==null?void 0:h.filter(p=>p.trim()!=="").length)||0;c=g===0?"No Comments":g===1?"1 Comment":`${g} Comments`}else if(this.groupingMode==="parent"){let g=l.filePath.split("/");g.length>1?c=g[g.length-2]:c="Root"}else if(this.groupingMode==="collection"){let g=this.plugin.collectionsManager.getAllCollections().filter(p=>p.highlightIds.includes(l.id));g.length===0?c="No Collections":g.length===1?c=g[0].name:c=g.map(p=>p.name).sort().join(", ")}else if(this.groupingMode==="filename")c=(l.filePath.split("/").pop()||l.filePath).replace(/\.md$/,"");else if(this.groupingMode==="date-created-asc"||this.groupingMode==="date-created-desc")if(l.createdAt){let g=new Date(l.createdAt),p=g.getFullYear(),v=String(g.getMonth()+1).padStart(2,"0"),m=String(g.getDate()).padStart(2,"0");c=`${p}-${v}-${m}`}else c="No Date";else c="Default";i.has(c)||i.set(c,[]),i.get(c).push(l)});let n=Array.from(i.entries()).map(([l,c])=>{let h;return this.groupingMode==="date-created-asc"||this.groupingMode==="date-created-desc"?h=c.sort((g,p)=>{let v=g.createdAt||0,m=p.createdAt||0;return this.groupingMode==="date-created-asc"?v-m:m-v}):h=c.sort((g,p)=>g.startOffset-p.startOffset),[l,h]}).sort(([l],[c])=>{if(this.groupingMode==="comments-asc"||this.groupingMode==="comments-desc"){if(l==="No Comments"&&c==="No Comments")return 0;if(l==="No Comments")return this.groupingMode==="comments-asc"?-1:1;if(c==="No Comments")return this.groupingMode==="comments-asc"?1:-1;let h=parseInt(l.split(" ")[0])||0,g=parseInt(c.split(" ")[0])||0;return this.groupingMode==="comments-asc"?h-g:g-h}else{if(this.groupingMode==="tag")return l==="No Tags"&&c==="No Tags"?0:l==="No Tags"?1:c==="No Tags"?-1:l.localeCompare(c);if(this.groupingMode==="parent")return l==="Root"&&c==="Root"?0:l==="Root"?-1:c==="Root"?1:l.localeCompare(c);if(this.groupingMode==="collection")return l==="No Collections"&&c==="No Collections"?0:l==="No Collections"?1:c==="No Collections"?-1:l.localeCompare(c);if(this.groupingMode==="filename")return l.localeCompare(c);if(this.groupingMode==="date-created-asc"||this.groupingMode==="date-created-desc"){if(l==="No Date"&&c==="No Date")return 0;if(l==="No Date")return 1;if(c==="No Date")return-1;let h=new Date(l),g=new Date(c);return this.groupingMode==="date-created-asc"?h.getTime()-g.getTime():g.getTime()-h.getTime()}}return l.localeCompare(c)});this.totalGroups=n,this.isPreservingPagination||(this.currentGroupPage=0);let a=n.reduce((l,[,c])=>l+c.length,0),r=Math.max(0,Math.ceil(a/this.itemsPerPage)-1);this.currentGroupPage>r&&(this.currentGroupPage=r),this.renderCurrentGroupPage(e,s),this.renderGroupPaginationControls(),this.isPreservingPagination=!1}renderCurrentGroupPage(t,e){let i=this.currentGroupPage*this.itemsPerPage,s=i+this.itemsPerPage;this.listContainerEl.empty();let n=0,a=0;for(let[r,l]of this.totalGroups){let c=l.length;if(n+c>i&&n<s){let h=Math.max(0,i-n),g=Math.min(c,s-n),p=l.slice(h,g);p.length>0&&(this.renderGroupHeader(r,l,e),p.forEach(v=>{this.createHighlightItem(this.listContainerEl,v,t,!0),a++}))}if(n+=c,n>=s)break}}renderGroupHeader(t,e,i){let s=this.listContainerEl.createDiv({cls:"highlight-group-header"}),n=s.createSpan();if(this.groupingMode==="color"&&(i!=null&&i.has(t))){let T=i.get(t),S=n.createDiv({cls:"group-color-square",attr:{"data-color":T}});S.style.backgroundColor=T}if(this.groupingMode==="tag"){let T=n.createDiv({cls:"group-tag-icon"});(0,C.setIcon)(T,"tag")}let a=n.createSpan();a.textContent=this.groupingMode==="color"?this.getColorName(t):t;let l=s.createDiv({cls:"collection-stats"}).createEl("small",{cls:"collection-info-line"}),h=new Set(e.map(T=>T.filePath)).size,g=e.filter(T=>T.isNativeComment).length,p=e.filter(T=>!T.isNativeComment).length,v=l.createDiv({cls:"highlight-line-info"}),m=v.createDiv({cls:"line-icon"});if((0,C.setIcon)(m,"highlighter"),v.createSpan({text:`${p}`}),this.showNativeComments){let T=l.createDiv({cls:"highlight-line-info"}),S=T.createDiv({cls:"line-icon"});(0,C.setIcon)(S,"captions"),T.createSpan({text:`${g}`})}let f=l.createDiv({cls:"highlight-line-info"}),d=f.createDiv({cls:"line-icon"});(0,C.setIcon)(d,"files"),f.createSpan({text:`${h}`})}renderSingleGroup(t,e,i,s=!1,n){this.renderGroupHeader(t,e,n);let a;this.groupingMode==="date-created-asc"||this.groupingMode==="date-created-desc"?a=e.sort((r,l)=>{let c=r.createdAt||0,h=l.createdAt||0;return this.groupingMode==="date-created-asc"?c-h:h-c}):a=e.sort((r,l)=>r.startOffset-l.startOffset),a.forEach(r=>{this.createHighlightItem(this.listContainerEl,r,i,s)})}renderGroupPaginationControls(){let t=this.listContainerEl.querySelector(".pagination-controls");t&&t.remove();let e=this.totalGroups.reduce((l,[,c])=>l+c.length,0),i=Math.ceil(e/this.itemsPerPage);if(i<=1)return;let s=this.listContainerEl.createDiv({cls:"pagination-controls"}),n=s.createEl("button",{cls:"clickable-icon"});n.disabled=this.currentGroupPage===0,(0,C.setIcon)(n,"chevron-left"),n.addEventListener("click",()=>{this.currentGroupPage>0&&(this.currentGroupPage--,this.renderCurrentGroupPage(this.getSearchTerm()),this.renderGroupPaginationControls(),requestAnimationFrame(()=>{this.contentAreaEl.scrollTop=0}))});let a=s.createSpan({text:`${this.currentGroupPage+1}/${i}`,cls:"pagination-info pagination-info-compact"}),r=s.createEl("button",{cls:"clickable-icon"});r.disabled=this.currentGroupPage>=i-1,(0,C.setIcon)(r,"chevron-right"),r.addEventListener("click",()=>{this.currentGroupPage<i-1&&(this.currentGroupPage++,this.renderCurrentGroupPage(this.getSearchTerm()),this.renderGroupPaginationControls(),requestAnimationFrame(()=>{this.contentAreaEl.scrollTop=0}))})}updateGroupButtonState(t){this.groupingMode==="none"?t.classList.remove("active"):t.classList.add("active")}saveGroupingModeToSettings(){this.plugin.settings.groupingMode=this.groupingMode,this.plugin.saveSettings()}createHighlightItem(t,e,i,s=!1){let r={searchTerm:this.currentSearchTokens.filter(l=>l.type==="text"&&!l.exclude).map(l=>l.value).join(" ")||i,showFilename:this.plugin.settings.showFilenames&&s,showTimestamp:this.plugin.settings.showTimestamps,showHighlightActions:this.plugin.settings.showHighlightActions,isCommentsVisible:this.highlightCommentsVisible.get(e.id)||!1,dateFormat:this.plugin.settings.dateFormat,onCommentToggle:l=>{let c=this.highlightCommentsVisible.get(l)||!1;this.highlightCommentsVisible.set(l,!c),this.rerenderCurrentView()},onCollectionsMenu:(l,c)=>{this.showCollectionsMenu(l,c)},onColorChange:(l,c)=>{this.preservedScrollTop=this.contentAreaEl.scrollTop,this.isColorChanging=!0,window.setTimeout(()=>{this.isColorChanging=!1},2e3),this.changeHighlightColor(l,c),this.rerenderCurrentView(),requestAnimationFrame(()=>{if(this.contentAreaEl&&this.isColorChanging&&(this.contentAreaEl.scrollTop=this.preservedScrollTop,this.isColorChanging=!1,this.plugin.selectedHighlightId)){let h=this.containerEl.querySelector(`[data-highlight-id="${this.plugin.selectedHighlightId}"]`);if(h){let g=this.getHighlightById(this.plugin.selectedHighlightId);if(g){let p=g.color||this.plugin.settings.highlightColor;h.style.borderLeftColor=p,g.isNativeComment||(h.style.boxShadow=`0 0 0 1.5px ${p}, var(--shadow-s)`)}}}})},onHighlightClick:(l,c)=>{this.focusHighlightInEditor(l,c)},onAddComment:async l=>{this.isPreservingPagination=!0,await this.focusHighlightInEditor(l),this.addFootnoteToHighlightWithTargetedUpdate(l)},onCommentClick:(l,c,h)=>{var v;let g=-1,p=0;for(let m=0;m<(((v=l.footnoteContents)==null?void 0:v.length)||0);m++)if(l.footnoteContents[m].trim()!==""){if(p===c){g=m;break}p++}g!==-1&&this.focusFootnoteInEditor(l,g,h)},onTagClick:l=>{this.selectedTags.has(l)?this.selectedTags.delete(l):this.selectedTags.add(l),this.renderFilteredList(),this.showTagActive()},onFileNameClick:(l,c)=>{this.isPreservingPagination=!0,this.plugin.app.workspace.openLinkText(l,l,C.Keymap.isModEvent(c))}};return this.highlightRenderer.createHighlightItem(t,e,r)}rerenderCurrentView(){this.viewMode==="collections"&&this.currentCollectionId?this.renderCollectionDetailView(this.currentCollectionId):this.renderFilteredList()}async addFootnoteToHighlightWithTargetedUpdate(t){let e=this.plugin.app.workspace.getActiveViewOfType(C.MarkdownView);if(!e)return;let i=e.editor,s=e.file;if(!s)return;let a=i.getValue().split(`
`),r=-1,l=null;for(let c=0;c<a.length;c++){let h=a[c];if(t.isNativeComment){if(h.includes(`%%${t.text}%%`)){r=c;let g=h.indexOf(`%%${t.text}%%`)+`%%${t.text}%%`.length,p=h.substring(g),v=p.match(/^(\s*(\[\^[a-zA-Z0-9_-]+\]|\^\[[^\]]+\]))*/),m=v?v[0].length:0;if(m>0&&p.length>m){let f=p.substring(m);if(!f.match(/^\S/)){let d=f.match(/^(\s+)/);if(d){let T=d[1];f.substring(d[0].length).length===0&&(m+=d[0].length)}}}else if(m>0){let f=p.substring(m).match(/^\s+/);f&&(m+=f[0].length)}l={line:c,ch:g+m};break}}else if(this.isHtmlHighlight(t)){let g=this.getHtmlHighlightPatterns(t),p=!1;for(let{pattern:v}of g){let f=new RegExp(v,"gi").exec(h);if(f){r=c;let d=f.index+f[0].length,T=h.substring(d),S=T.match(/^(\s*(\[\^[a-zA-Z0-9_-]+\]|\^\[[^\]]+\]))*/),u=S?S[0].length:0;if(u>0&&T.length>u){let x=T.substring(u);if(!x.match(/^\S/)){let b=x.match(/^(\s+)/);if(b){let y=b[1];x.substring(b[0].length).length===0&&(u+=b[0].length)}}}else if(u>0){let x=T.substring(u).match(/^\s+/);x&&(u+=x[0].length)}l={line:c,ch:d+u},p=!0;break}}if(p)break}else if(h.includes(`==${t.text}==`)){r=c;let g=h.indexOf(`==${t.text}==`)+`==${t.text}==`.length,p=h.substring(g),v=p.match(/^(\s*(\[\^[a-zA-Z0-9_-]+\]|\^\[[^\]]+\]))*/),m=v?v[0].length:0;if(m>0&&p.length>m){let f=p.substring(m);if(!f.match(/^\S/)){let d=f.match(/^(\s+)/);if(d){let T=d[1];f.substring(d[0].length).length===0&&(m+=d[0].length)}}}else if(m>0){let f=p.substring(m).match(/^\s+/);f&&(m+=f[0].length)}l={line:c,ch:g+m};break}}if(!l){new C.Notice("Could not find the highlight in the editor. It might have been modified.");return}i.setCursor(l),i.focus(),this.plugin.settings.useInlineFootnotes?this.plugin.inlineFootnoteManager.insertInlineFootnote(i,t,"")?setTimeout(async()=>{await this.updateSingleHighlightFromEditor(t,s)},50):new C.Notice("Could not insert inline footnote."):(this.plugin.app.commands.executeCommandById("editor:insert-footnote"),setTimeout(async()=>{await this.updateSingleHighlightFromEditor(t,s)},100))}async updateSingleHighlightFromEditor(t,e){let i=this.plugin.app.workspace.getActiveViewOfType(C.MarkdownView);if(!i)return;let s=i.editor.getValue(),n=this.plugin.extractFootnotes(s),a=this.findAndParseHighlight(s,t,n);if(a){let r=this.plugin.highlights.get(e.path)||[],l=r.findIndex(c=>c.id===t.id);l!==-1&&(r[l]=a,this.plugin.highlights.set(e.path,r),await this.plugin.saveSettings(),this.updateItem(t.id))}}findAndParseHighlight(t,e,i){let s=e.isNativeComment?new RegExp(`%%${this.escapeRegex(e.text)}%%`,"g"):new RegExp(`==${this.escapeRegex(e.text)}==`,"g"),n;for(;(n=s.exec(t))!==null;)if(Math.abs(n.index-e.startOffset)<100){let a=t.slice(n.index+n[0].length),r=[];this.plugin.inlineFootnoteManager.extractInlineFootnotes(t,n.index+n[0].length).forEach(m=>{m.content.trim()&&r.push({type:"inline",index:m.startIndex,content:m.content.trim()})});let c=/(\s*\[\^(\w+)\])(?!:)/g,h,g=0;for(;(h=c.exec(a))!==null;){let m=a.substring(g,h.index),f=/^(\s*(\[\^[a-zA-Z0-9_-]+\]|\^\[[^\]]+\])\s*)*\s*$/.test(m);if(h.index===g||f){let d=h[2];if(i.has(d)){let T=i.get(d).trim();T&&r.push({type:"standard",index:n.index+n[0].length+h.index,content:T})}g=h.index+h[0].length}else break}r.sort((m,f)=>m.index-f.index);let p=r.map(m=>m.content),v=p.length;return{...e,footnoteCount:v,footnoteContents:p,startOffset:n.index,endOffset:n.index+n[0].length}}return null}async focusHighlightInEditor(t,e){var l;this.isPreservingPagination=!0,this.containerEl.querySelectorAll(".selected, .highlight-selected").forEach(c=>{c.classList.remove("selected","highlight-selected"),c.style.removeProperty("border-left-color"),c.style.removeProperty("box-shadow")});let s=this.plugin.selectedHighlightId;this.plugin.selectedHighlightId=t.id;let n=this.containerEl.querySelector(`[data-highlight-id="${t.id}"]`);if(n){n.classList.add("selected");let c=this.plugin.highlights.get(t.filePath),h=c==null?void 0:c.find(g=>g.id===t.id);if(h){n.classList.add("highlight-selected");let g=h.color||this.plugin.settings.highlightColor;n.style.borderLeftColor=g,h.isNativeComment||(n.style.boxShadow=`0 0 0 1.5px ${g}, var(--shadow-s)`)}}if(this.isHighlightFocusing)return;this.preservedScrollTop=this.contentAreaEl.scrollTop,this.isHighlightFocusing=!0,window.setTimeout(()=>{this.isHighlightFocusing=!1},2e3);let a=null,r=this.plugin.app.workspace.getActiveViewOfType(C.MarkdownView);if(r&&r.file&&r.file.path===t.filePath)a=r;else{let c=this.plugin.app.workspace.getLeavesOfType("markdown");for(let h of c)if(h.view instanceof C.MarkdownView&&((l=h.view.file)==null?void 0:l.path)===t.filePath){a=h.view,this.plugin.app.workspace.setActiveLeaf(h,{focus:!0});break}}if(!a&&this.plugin.app.vault.getAbstractFileByPath(t.filePath)instanceof C.TFile){let h=await this.plugin.app.workspace.openLinkText(t.filePath,t.filePath,e?C.Keymap.isModEvent(e):!1);return new Promise(g=>{let p=()=>{var m;let v=this.plugin.app.workspace.getActiveViewOfType(C.MarkdownView);v&&((m=v.file)==null?void 0:m.path)===t.filePath?(this.performHighlightFocus(v,t),g()):window.setTimeout(p,50)};window.setTimeout(p,100)})}a&&requestAnimationFrame(()=>{this.performHighlightFocus(a,t)})}isHtmlHighlight(t){return!t.isNativeComment&&!!t.color}getHtmlHighlightPatterns(t){let e=this.escapeRegex(t.text),i=[];return i.push({pattern:`<span\\s+style=["'][^"']*background:\\s*[^;"']+[^"']*["'][^>]*>${e}<\\/span>`,tagLength:0}),i.push({pattern:`<font\\s+color=["'][^"']+["'][^>]*>${e}<\\/font>`,tagLength:0}),i.push({pattern:`<mark[^>]*>${e}<\\/mark>`,tagLength:0}),i}performHighlightFocus(t,e){if(!t||!t.editor)return;this.contentAreaEl.scrollTop!==this.preservedScrollTop?requestAnimationFrame(()=>{this.contentAreaEl.scrollTop=this.preservedScrollTop,this.isHighlightFocusing=!1}):this.isHighlightFocusing=!1;let s=t.editor.getValue(),n=[];if(e.isNativeComment){let g=`%%${this.escapeRegex(e.text)}%%`,p=new RegExp(g,"g"),v;for(;(v=p.exec(s))!==null;)n.push({index:v.index,length:v[0].length,tagStartLength:2,tagEndLength:2})}else if(this.isHtmlHighlight(e)){let g=this.getHtmlHighlightPatterns(e);for(let{pattern:p}of g){let v=new RegExp(p,"gi"),m;for(;(m=v.exec(s))!==null;){let f=m[0],d=f.lastIndexOf(e.text),T=d,S=f.length-d-e.text.length;n.push({index:m.index,length:m[0].length,tagStartLength:T,tagEndLength:S})}}}else{let g=`==${this.escapeRegex(e.text)}==`,p=new RegExp(g,"g"),v;for(;(v=p.exec(s))!==null;)n.push({index:v.index,length:v[0].length,tagStartLength:2,tagEndLength:2})}if(n.length===0)return;let a=n[0],r=1/0,l=!1;for(let g of n){let p=Math.abs(g.index-e.startOffset);p<r&&(r=p,a=g,l=!0)}!l||r>50;let c=t.editor.offsetToPos(a.index+a.tagStartLength),h=t.editor.offsetToPos(a.index+a.length-a.tagEndLength);t.editor.scrollIntoView({from:c,to:h},!0),t.editor.focus()}focusHighlight(t){let e=this.containerEl.querySelector(`[data-highlight-id="${t}"]`)}escapeRegex(t){return t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}async focusFootnoteInEditor(t,e,i){var a;let s=null,n=this.plugin.app.workspace.getActiveViewOfType(C.MarkdownView);if(n&&n.file&&n.file.path===t.filePath)s=n;else{let r=this.plugin.app.workspace.getLeavesOfType("markdown");for(let l of r)if(l.view instanceof C.MarkdownView&&((a=l.view.file)==null?void 0:a.path)===t.filePath){s=l.view,this.plugin.app.workspace.setActiveLeaf(l,{focus:!0});break}}if(!s&&this.plugin.app.vault.getAbstractFileByPath(t.filePath)instanceof C.TFile){await this.plugin.app.workspace.openLinkText(t.filePath,t.filePath,i?C.Keymap.isModEvent(i):!1),window.setTimeout(()=>this.focusFootnoteInEditor(t,e,i),200);return}window.setTimeout(()=>{let r=this.plugin.app.workspace.getActiveViewOfType(C.MarkdownView);if(!r||!r.editor){new C.Notice("Could not access the editor.");return}let l=r.editor,c=l.getValue(),h=this.escapeRegex(t.text),g=null,p=1/0;if(t.isNativeComment){let b=`%%${h}%%`,y=new RegExp(b,"g"),w;for(;(w=y.exec(c))!==null;){let H=Math.abs(w.index-t.startOffset);H<p&&(p=H,g={index:w.index,length:w[0].length})}}else if(this.isHtmlHighlight(t)){let b=this.getHtmlHighlightPatterns(t);for(let{pattern:y}of b){let w=new RegExp(y,"gi"),H;for(;(H=w.exec(c))!==null;){let k=Math.abs(H.index-t.startOffset);k<p&&(p=k,g={index:H.index,length:H[0].length})}}}else{let b=`==${h}==`,y=new RegExp(b,"g"),w;for(;(w=y.exec(c))!==null;){let H=Math.abs(w.index-t.startOffset);H<p&&(p=H,g={index:w.index,length:w[0].length})}}if(!g){new C.Notice("Could not find the highlight in the editor.");return}let v=new B,m=c.substring(g.index+g.length),f=[];v.extractInlineFootnotes(c,g.index+g.length).forEach(b=>{f.push({type:"inline",content:b.content,startIndex:b.startIndex,endIndex:b.endIndex})});let T=/(\s*\[\^(\w+)\])/g,S,u=0;for(;(S=T.exec(m))!==null;){let b=m.substring(u,S.index),y=/^(\s*(\[\^[a-zA-Z0-9_-]+\]|\^\[[^\]]+\])\s*)*\s*$/.test(b);if(S.index===u||y)f.push({type:"standard",content:S[2],startIndex:g.index+g.length+S.index,endIndex:g.index+g.length+S.index+S[0].length}),u=S.index+S[0].length;else break}if(f.sort((b,y)=>b.startIndex-y.startIndex),f.length===0){new C.Notice("No footnotes found for this highlight.");return}if(e>=f.length){new C.Notice("Footnote index out of range.");return}let x=f[e];if(x.type==="inline"){let b=c.substring(x.startIndex,x.endIndex),y=b.indexOf("^"),w=x.startIndex+y,H=l.offsetToPos(w);if(this.plugin.settings.selectTextOnCommentClick){let k=x.startIndex+b.indexOf("[")+1,M=x.startIndex+b.lastIndexOf("]"),N=l.offsetToPos(k),L=l.offsetToPos(M);l.scrollIntoView({from:N,to:L},!0),l.setSelection(N,L),l.focus()}else l.scrollIntoView({from:H,to:H},!0),l.setCursor(H),l.focus()}else{let b=x.content,y=new RegExp(`^\\[\\^${this.escapeRegex(b)}\\]:\\s*(.+)$`,"m"),w=c.match(y);if(!w){new C.Notice("Could not find footnote definition.");return}let H=c.indexOf(w[0]),k=l.offsetToPos(H);if(this.plugin.settings.selectTextOnCommentClick){let M=w[1],N=H+w[0].indexOf(M),L=N+M.length,tt=l.offsetToPos(N),G=l.offsetToPos(L);l.scrollIntoView({from:tt,to:G},!0),l.setSelection(tt,G),l.focus()}else l.scrollIntoView({from:k,to:k},!0),l.setCursor(k),l.focus()}},150)}changeHighlightColor(t,e){this.plugin.updateHighlight(t.id,{color:e},t.filePath)}getColorName(t){let e=this.plugin.settings.customColorNames,i=this.plugin.settings.customColors;return t===i.yellow&&e.yellow.trim()?e.yellow.trim():t===i.red&&e.red.trim()?e.red.trim():t===i.teal&&e.teal.trim()?e.teal.trim():t===i.blue&&e.blue.trim()?e.blue.trim():t===i.green&&e.green.trim()?e.green.trim():t}renderGroupedHighlights(t,e,i=!1){let s=new Map,n=new Map;t.forEach(r=>{var c;let l;if(this.groupingMode==="color"){let h=r.color||this.plugin.settings.highlightColor;l=h,n.set(l,h)}else if(this.groupingMode==="comments-asc"||this.groupingMode==="comments-desc"){let h=r.isNativeComment?0:((c=r.footnoteContents)==null?void 0:c.filter(g=>g.trim()!=="").length)||0;l=h===0?"No Comments":h===1?"1 Comment":`${h} Comments`}else if(this.groupingMode==="parent"){let h=r.filePath.split("/");h.length>1?l=h[h.length-2]:l="Root"}else if(this.groupingMode==="collection"){let h=this.plugin.collectionsManager.getAllCollections().filter(g=>g.highlightIds.includes(r.id));h.length===0?l="No Collections":h.length===1?l=h[0].name:l=h.map(g=>g.name).sort().join(", ")}else if(this.groupingMode==="filename")l=(r.filePath.split("/").pop()||r.filePath).replace(/\.md$/,"");else if(this.groupingMode==="date-created-asc"||this.groupingMode==="date-created-desc")if(r.createdAt){let h=new Date(r.createdAt),g=h.getFullYear(),p=String(h.getMonth()+1).padStart(2,"0"),v=String(h.getDate()).padStart(2,"0");l=`${g}-${p}-${v}`}else l="No Date";else l="Default";s.has(l)||s.set(l,[]),s.get(l).push(r)}),Array.from(s.entries()).sort(([r],[l])=>{if(this.groupingMode==="comments-asc"||this.groupingMode==="comments-desc"){if(r==="No Comments"&&l==="No Comments")return 0;if(r==="No Comments")return this.groupingMode==="comments-asc"?-1:1;if(l==="No Comments")return this.groupingMode==="comments-asc"?1:-1;let c=parseInt(r.split(" ")[0])||0,h=parseInt(l.split(" ")[0])||0;return this.groupingMode==="comments-asc"?c-h:h-c}else{if(this.groupingMode==="tag")return r==="No Tags"&&l==="No Tags"?0:r==="No Tags"?1:l==="No Tags"?-1:r.localeCompare(l);if(this.groupingMode==="parent")return r==="Root"&&l==="Root"?0:r==="Root"?-1:l==="Root"?1:r.localeCompare(l);if(this.groupingMode==="collection")return r==="No Collections"&&l==="No Collections"?0:r==="No Collections"?1:l==="No Collections"?-1:r.localeCompare(l);if(this.groupingMode==="filename")return r.localeCompare(l);if(this.groupingMode==="date-created-asc"||this.groupingMode==="date-created-desc"){if(r==="No Date"&&l==="No Date")return 0;if(r==="No Date")return 1;if(l==="No Date")return-1;let c=new Date(r),h=new Date(l);return this.groupingMode==="date-created-asc"?c.getTime()-h.getTime():h.getTime()-c.getTime()}}return r.localeCompare(l)}).forEach(([r,l])=>{let c=this.listContainerEl.createDiv({cls:"highlight-group-header"}),h=c.createSpan();if(this.groupingMode==="color"&&n.has(r)){let w=n.get(r),H=h.createDiv({cls:"group-color-square",attr:{"data-color":w}});H.style.backgroundColor=w}if(this.groupingMode==="tag"){let w=h.createDiv({cls:"group-tag-icon"});(0,C.setIcon)(w,"tag")}let g=h.createSpan();g.textContent=this.groupingMode==="color"?this.getColorName(r):r;let v=c.createDiv({cls:"collection-stats"}).createEl("small",{cls:"collection-info-line"}),f=new Set(l.map(w=>w.filePath)).size,d=l.filter(w=>w.isNativeComment).length,T=l.filter(w=>!w.isNativeComment).length,S=v.createDiv({cls:"highlight-line-info"}),u=S.createDiv({cls:"line-icon"});if((0,C.setIcon)(u,"highlighter"),S.createSpan({text:`${T}`}),this.showNativeComments){let w=v.createDiv({cls:"highlight-line-info"}),H=w.createDiv({cls:"line-icon"});(0,C.setIcon)(H,"captions"),w.createSpan({text:`${d}`})}let x=v.createDiv({cls:"highlight-line-info"}),b=x.createDiv({cls:"line-icon"});(0,C.setIcon)(b,"file-text"),x.createSpan({text:`${f}`});let y;this.groupingMode==="date-created-asc"||this.groupingMode==="date-created-desc"?y=l.sort((w,H)=>{let k=w.createdAt||0,M=H.createdAt||0;return this.groupingMode==="date-created-asc"?k-M:M-k}):y=l.sort((w,H)=>w.startOffset-H.startOffset),y.forEach(w=>{this.createHighlightItem(this.listContainerEl,w,e,i)})})}updateCommentsToggleIcon(t){t.empty();let e;if(this.viewMode==="current")e=this.plugin.getCurrentFileHighlights();else if(this.viewMode==="all"){e=[];for(let[,n]of this.plugin.highlights)e.push(...n)}else this.viewMode==="collections"&&this.currentCollectionId?e=this.plugin.collectionsManager.getHighlightsInCollection(this.currentCollectionId):e=[];let s=e.some(n=>{var r;return n.isNativeComment?!1:(((r=n.footnoteContents)==null?void 0:r.filter(l=>l.trim()!=="").length)||0)>0&&this.highlightCommentsVisible.get(n.id)})?"chevrons-down-up":"chevrons-up-down";(0,C.setIcon)(t,s)}toggleAllComments(){let t;if(this.viewMode==="current")t=this.plugin.getCurrentFileHighlights();else if(this.viewMode==="all"){t=[];for(let[,s]of this.plugin.highlights)t.push(...s)}else this.viewMode==="collections"&&this.currentCollectionId?t=this.plugin.collectionsManager.getHighlightsInCollection(this.currentCollectionId):t=[];let i=!t.some(s=>{var a;return s.isNativeComment?!1:(((a=s.footnoteContents)==null?void 0:a.filter(r=>r.trim()!=="").length)||0)>0&&this.highlightCommentsVisible.get(s.id)});t.forEach(s=>{var a;if(s.isNativeComment)return;(((a=s.footnoteContents)==null?void 0:a.filter(r=>r.trim()!=="").length)||0)>0&&this.highlightCommentsVisible.set(s.id,i)})}resetAllColors(){let t;if(this.viewMode==="current")t=this.plugin.getCurrentFileHighlights();else if(this.viewMode==="all"){t=[];for(let[,i]of this.plugin.highlights)t.push(...i)}else this.viewMode==="collections"&&this.currentCollectionId?t=this.plugin.collectionsManager.getHighlightsInCollection(this.currentCollectionId):t=[];let e=!1;t.forEach(i=>{if(i.color){let s=this.plugin.highlights.get(i.filePath);if(s){let n=s.find(a=>a.id===i.id);if(n&&n.color){let a={...n,color:void 0},r=s.indexOf(n);s[r]=a,this.plugin.highlights.set(i.filePath,[...s]),e=!0}}}}),e&&(this.plugin.saveSettings(),this.renderContent())}extractTagsFromHighlight(t){let e=[];if(t.footnoteContents){for(let i of t.footnoteContents)if(i.trim()!==""){let s=i.match(/#[\p{L}\p{N}\p{M}_/-]+/gu);s&&s.forEach(n=>{let a=n.substring(1);e.includes(a)||e.push(a)})}}return e}getAllTagsInFile(){let t=new Set;if(this.viewMode==="current")this.plugin.getCurrentFileHighlights().forEach(i=>{this.extractTagsFromHighlight(i).forEach(n=>t.add(n))});else if(this.viewMode==="all")for(let[e,i]of this.plugin.highlights)i.forEach(s=>{this.extractTagsFromHighlight(s).forEach(a=>t.add(a))});else this.viewMode==="collections"&&this.currentCollectionId&&this.plugin.collectionsManager.getHighlightsInCollection(this.currentCollectionId).forEach(i=>{this.extractTagsFromHighlight(i).forEach(n=>t.add(n))});return Array.from(t).sort((e,i)=>e.localeCompare(i,void 0,{numeric:!0,sensitivity:"base"}))}getAllCollectionsInCurrentScope(){let t=new Set,e=[];if(this.viewMode==="current")e=this.plugin.getCurrentFileHighlights();else if(this.viewMode==="all")for(let[s,n]of this.plugin.highlights)e.push(...n);else this.viewMode==="collections"&&this.currentCollectionId&&(e=this.plugin.collectionsManager.getHighlightsInCollection(this.currentCollectionId));return e.forEach(s=>{this.plugin.collectionsManager.getCollectionsForHighlight(s.id).forEach(a=>{t.add(a.id)})}),this.plugin.collectionsManager.getAllCollections().filter(s=>t.has(s.id))}showTagFilterMenu(t){let e=this.getAllTagsInFile(),i=this.getAllCollectionsInCurrentScope();if(e.length===0&&i.length===0){new C.Notice("No tags or collections found");return}let s=i.sort((a,r)=>a.name.localeCompare(r.name,void 0,{numeric:!0,sensitivity:"base"})),n=[{text:"Clear",icon:"x",className:"highlights-dropdown-clear",onClick:()=>{this.selectedTags.clear(),this.selectedCollections.clear(),this.renderContent(),this.showTagActive();let a={};e.forEach(r=>{a[`tag-${r}`]=!1}),s.forEach(r=>{a[`collection-${r.id}`]=!1}),this.dropdownManager.updateAllCheckboxStates(a)}}];e.length>0&&n.push(...e.map(a=>({id:`tag-${a}`,text:`#${a}`,uncheckedIcon:"tag",checked:this.selectedTags.has(a),onClick:()=>{this.selectedTags.has(a)?this.selectedTags.delete(a):this.selectedTags.add(a),this.renderContent(),this.showTagActive()}}))),e.length>0&&s.length>0&&n.push({text:"",separator:!0}),s.length>0&&n.push(...s.map(a=>({id:`collection-${a.id}`,text:a.name,uncheckedIcon:"folder-open",checked:this.selectedCollections.has(a.name),onClick:()=>{this.selectedCollections.has(a.name)?this.selectedCollections.delete(a.name):this.selectedCollections.add(a.name),this.renderContent(),this.showTagActive()}}))),this.dropdownManager.showDropdown(t.currentTarget,n)}showCollectionsMenu(t,e){let i=this.plugin.collectionsManager.getAllCollections(),s=[{text:"Clear",icon:"x",className:"highlights-dropdown-clear",onClick:()=>{i.forEach(a=>{this.plugin.collectionsManager.removeHighlightFromCollection(a.id,e.id)}),this.updateHighlightCollectionCount(e),this.viewMode==="collections"&&this.renderContent(),this.groupingMode==="collection"&&this.renderContent();let n={};i.forEach(a=>{n[`collection-${a.id}`]=!1}),this.dropdownManager.updateAllCheckboxStates(n)}},{text:"New collection",icon:"plus",className:"highlights-dropdown-clear",onClick:()=>{this.showNewCollectionDialog(e.id)}}];i.length>0?s.push(...i.map(n=>({id:`collection-${n.id}`,text:n.name,uncheckedIcon:"folder-open",checked:n.highlightIds.includes(e.id),onClick:()=>{n.highlightIds.includes(e.id)?(this.plugin.collectionsManager.removeHighlightFromCollection(n.id,e.id),this.updateHighlightCollectionCount(e),this.viewMode==="collections"&&this.currentCollectionId===n.id&&this.renderContent(),this.groupingMode==="collection"&&this.renderContent()):(this.plugin.collectionsManager.addHighlightToCollection(n.id,e.id),this.updateHighlightCollectionCount(e),this.groupingMode==="collection"&&this.renderContent())}}))):s.push({text:"No collections available",className:"highlights-dropdown-empty",onClick:()=>{}}),this.dropdownManager.showDropdown(t.currentTarget,s)}updateCollectionNavButton(t){t.empty(),this.viewMode==="collections"&&this.currentCollectionId?((0,C.setIcon)(t,"arrow-left"),(0,C.setTooltip)(t,"Back to Collections"),t.classList.add("active","collection-nav-back")):((0,C.setIcon)(t,"folder-plus"),(0,C.setTooltip)(t,"New collection"),t.classList.remove("active","collection-nav-back"))}toggleSearch(){var e;if(!this.plugin.settings.showToolbar)return;this.searchExpanded=!this.searchExpanded;let t=this.contentEl.querySelector(".highlights-search-input-container");t&&(this.searchExpanded?(t.classList.remove("hidden"),this.searchButton.classList.add("active"),(0,C.setIcon)(this.searchButton,"x"),(0,C.setTooltip)(this.searchButton,"Close search"),window.setTimeout(()=>this.searchInputEl.focus(),100)):(t.classList.add("hidden"),this.searchButton.classList.remove("active"),(0,C.setIcon)(this.searchButton,"search"),(0,C.setTooltip)(this.searchButton,"Search highlights"),(e=this.simpleSearchManager)==null||e.clear(),this.currentSearchTokens=[],this.currentParsedSearch={ast:null},this.renderContent()))}enableSearchAndToolbar(){if(!this.plugin.settings.showToolbar)return;this.searchButton&&this.searchButton.classList.remove("disabled"),this.searchInputEl&&this.searchInputEl.classList.remove("disabled");let t=this.contentEl.querySelectorAll(".highlights-search-container button");t.forEach((i,s)=>{let n=s===t.length-1,a=s===2;this.viewMode==="collections"&&!this.currentCollectionId&&!n&&!a?i.classList.add("disabled"):i.classList.remove("disabled")});let e=this.contentEl.querySelector(".highlights-search-container button:last-of-type");e&&this.updateCollectionNavButton(e)}disableSearchAndToolbar(){if(!this.plugin.settings.showToolbar)return;this.searchButton&&this.searchButton.classList.add("disabled"),this.searchInputEl&&this.searchInputEl.classList.add("disabled");let t=this.contentEl.querySelectorAll(".highlights-search-container button");t.forEach((i,s)=>{s===t.length-1?i.classList.remove("disabled"):i.classList.add("disabled")});let e=this.contentEl.querySelector(".highlights-search-container button:last-of-type");e&&this.updateCollectionNavButton(e)}updateHighlightCollectionCount(t){let e=this.containerEl.querySelector(`[data-highlight-id="${t.id}"]`);if(!e)return;let i=e.querySelector(".highlight-line-info:last-child span");if(i){let s=this.plugin.collectionsManager.getHighlightCollectionCount(t.id);i.textContent=`${s}`}}showTagActive(){if(!this.plugin.settings.showToolbar)return;let t=this.contentEl.querySelector(".highlights-tag-filter-button");t&&(this.selectedTags.size>0||this.selectedCollections.size>0?t.classList.add("active"):t.classList.remove("active"))}showNewCollectionDialog(t){new W(this.plugin.app,(e,i)=>{let s=this.plugin.collectionsManager.createCollection(e,i);t&&this.plugin.collectionsManager.addHighlightToCollection(s.id,t),this.animateCollectionCreation(s.id)}).open()}showCollectionMenu(t,e){let i=new C.Menu;i.addItem(s=>{s.setTitle("Edit").setIcon("edit").onClick(()=>{this.showEditCollectionDialog(e)})}),i.addItem(s=>{s.setTitle("Delete").setIcon("trash").onClick(async()=>{await this.animateCollectionDeletion(e.id)})}),i.showAtMouseEvent(t)}showEditCollectionDialog(t){new _(this.plugin.app,t,(e,i)=>{t.name=e,t.description=i,this.plugin.saveSettings(),this.plugin.refreshSidebar()}).open()}updateNativeCommentsToggleState(t){this.showNativeComments?((0,C.setIcon)(t,"captions"),t.classList.remove("active"),(0,C.setTooltip)(t,"Toggle native comments")):((0,C.setIcon)(t,"captions-off"),t.classList.add("active"),(0,C.setTooltip)(t,"Toggle native comments"))}animateCollectionCreation(t){this.plugin.refreshSidebar(),requestAnimationFrame(()=>{let e=this.contentAreaEl.querySelector(`[data-collection-id="${t}"]`);e&&(e.classList.add("preparing-animation"),requestAnimationFrame(()=>{e.classList.remove("preparing-animation"),e.classList.add("animating-in"),window.setTimeout(()=>{e.classList.remove("animating-in")},400)}))})}async animateCollectionDeletion(t){let e=this.contentAreaEl.querySelector(`[data-collection-id="${t}"]`);if(!e)return await this.plugin.collectionsManager.deleteCollectionWithConfirmation(t);let i=this.plugin.collectionsManager.getCollection(t);return!i||!confirm(`Are you sure you want to delete "${i.name}"?`)?!1:(e.classList.add("animating-out"),new Promise(n=>{window.setTimeout(()=>{this.plugin.collectionsManager.deleteCollection(t),this.plugin.refreshSidebar(),n(!0)},220)}))}toggleNativeCommentsVisibility(){this.showNativeComments=!this.showNativeComments,this.plugin.app.saveLocalStorage("sidebar-highlights-show-native-comments",this.showNativeComments.toString())}handleSearchInput(t,e){this.currentParsedSearch=e,this.currentSearchTokens=A.getTokensFromQuery(t),this.renderContent()}removeSearchToken(t){this.simpleSearchManager.updateSuggestions({tags:this.getAvailableTags(),collections:this.getAvailableCollections()})}getHighlightById(t){for(let[e,i]of this.plugin.highlights){let s=i.find(n=>n.id===t);if(s)return s}return null}getAvailableTags(){let t=new Set;for(let e of this.plugin.highlights.values())for(let i of e)this.extractTagsFromHighlight(i).forEach(n=>t.add(n));return Array.from(t).sort()}getAvailableCollections(){return this.plugin.collectionsManager.getAllCollections().map(t=>t.name).sort()}applyAllFilters(t){return t.filter(e=>{if(!this.passesSmartSearchFilter(e))return!1;if(this.selectedTags.size>0){let s=this.extractTagsFromHighlight(e);if(!Array.from(this.selectedTags).some(a=>s.includes(a)))return!1}if(this.selectedCollections.size>0){let s=this.plugin.collectionsManager.getCollectionsForHighlight(e.id);if(!Array.from(this.selectedCollections).some(a=>s.some(r=>r.name===a)))return!1}return!(!this.showNativeComments&&e.isNativeComment)})}passesSmartSearchFilter(t){return this.currentParsedSearch.ast?this.evaluateASTNode(this.currentParsedSearch.ast,t):!0}evaluateASTNode(t,e){if(t.type==="filter"){let i=t,s=this.highlightMatchesFilter(e,i);return i.exclude?!s:s}else if(t.type==="text"){let i=t;return e.text.toLowerCase().includes(i.value.toLowerCase())||e.filePath.toLowerCase().replace(/\.md$/,"").includes(i.value.toLowerCase())}else if(t.type==="operator"){let i=t,s=this.evaluateASTNode(i.left,e),n=this.evaluateASTNode(i.right,e);return i.operator==="AND"?s&&n:s||n}return!1}isConsecutiveTextNodes(t){return this.containsOnlyTextNodes(t.left)&&this.containsOnlyTextNodes(t.right)}containsOnlyTextNodes(t){if(t.type==="text")return!0;if(t.type==="operator"){let e=t;return e.operator==="AND"&&this.containsOnlyTextNodes(e.left)&&this.containsOnlyTextNodes(e.right)}return!1}extractConsecutiveText(t){if(t.type==="text")return t.value;if(t.type==="operator"){let e=t,i=this.extractConsecutiveText(e.left),s=this.extractConsecutiveText(e.right);return`${i} ${s}`}return""}highlightMatchesFilter(t,e){return e.filterType==="tag"?this.extractTagsFromHighlight(t).includes(e.value):e.filterType==="collection"?this.plugin.collectionsManager.getCollectionsForHighlight(t.id).map(n=>n.name).includes(e.value):!1}};var K=require("obsidian");var V=require("obsidian"),j=class extends V.AbstractInputSuggest{constructor(t,e){super(t,e);this.inputEl=e,this.folders=this.app.vault.getAllFolders(!0).map(i=>(0,V.normalizePath)(i.path)).filter(i=>i!==""),this.files=this.app.vault.getFiles().map(i=>(0,V.normalizePath)(i.path))}getSuggestions(t){let e=t.toLowerCase().trim();if(!e)return this.folders.slice(0,10);let i=this.folders.filter(n=>n.toLowerCase().includes(e)),s=this.files.filter(n=>n.toLowerCase().includes(e));return[...i,...s].slice(0,20)}renderSuggestion(t,e){e.setText(t)}selectSuggestion(t){this.inputEl.value=t;let e=new Event("input");this.inputEl.dispatchEvent(e),this.close()}};var Z=class extends K.Modal{constructor(t,e,i){super(t);this.excludedFiles=[...e],this.onUpdate=i}onOpen(){let{contentEl:t}=this;t.empty(),t.createEl("div",{cls:"modal-title",text:"Excluded files"}),this.renderStatusMessage(t),this.renderExcludedFilesList(t);let e=t.createDiv({cls:"setting-item"});e.createDiv({cls:"setting-item-info"}).createDiv({cls:"setting-item-name",text:"Filter"});let n=e.createDiv({cls:"setting-item-control"}).createDiv({cls:"excluded-files-input-container"});n.style.display="flex",n.style.gap="8px",this.filterInput=n.createEl("input",{type:"text",placeholder:"Enter file or folder path..."}),this.filterInput.style.flex="1",this.fileFolderSuggest=new j(this.app,this.filterInput),n.createEl("button",{text:"Add",cls:"mod-cta"}).addEventListener("click",()=>this.addFilter()),this.filterInput.addEventListener("keydown",r=>{r.key==="Enter"&&this.addFilter()}),this.renderModalButtons(t)}renderStatusMessage(t){let e=t.querySelector(".excluded-files-status");e&&e.remove();let i=t.createDiv({cls:"excluded-files-status"});i.style.marginTop="20px",this.excludedFiles.length===0?(i.setText("No excluded filter is applied right now. Add one below."),i.style.paddingBottom="20px"):(i.setText("Files matching the following filters are currently excluded:"),i.style.paddingBottom="10px")}renderExcludedFilesList(t){let e=t.querySelector(".excluded-files-list");if(e&&e.remove(),this.excludedFiles.length>0){let i=t.querySelector(".setting-item"),s=t.createDiv({cls:"excluded-files-list"});i&&t.insertBefore(s,i),this.excludedFiles.forEach(n=>{let a=s.createDiv({cls:"setting-item excluded-file-item"});a.createDiv({cls:"setting-item-info"}).createDiv({cls:"setting-item-name",text:n});let c=a.createDiv({cls:"setting-item-control"}).createEl("button",{cls:"clickable-icon"});(0,K.setIcon)(c,"x"),c.addEventListener("click",()=>{this.removeFilter(n)})})}}renderModalButtons(t){let e=t.createDiv({cls:"modal-button-container"});e.style.display="flex",e.style.justifyContent="flex-end",e.style.gap="8px",e.style.marginTop="20px",e.createEl("button",{text:"Cancel"}).addEventListener("click",()=>this.close()),e.createEl("button",{text:"Save",cls:"mod-cta"}).addEventListener("click",()=>this.close())}addFilter(){let t=this.filterInput.value.trim();t&&!this.excludedFiles.includes(t)&&(this.excludedFiles.push(t),this.filterInput.value="",this.refreshContent(),this.onUpdate(this.excludedFiles))}removeFilter(t){this.excludedFiles=this.excludedFiles.filter(e=>e!==t),this.refreshContent(),this.onUpdate(this.excludedFiles)}refreshContent(){let t=this.contentEl.querySelector(".excluded-files-status");t&&(this.excludedFiles.length===0?(t.setText("No excluded filter is applied right now. Add one below."),t.style.paddingBottom="20px"):(t.setText("Files matching the following filters are currently excluded:"),t.style.paddingBottom="10px")),this.renderExcludedFilesList(this.contentEl)}onClose(){let{contentEl:t}=this;t.empty()}};var $={settingsVersion:"1.14.0",highlightColor:"#ffd700",sidebarPosition:"right",highlights:{},collections:{},groupingMode:"none",showFilenames:!0,showTimestamps:!0,showHighlightActions:!0,showToolbar:!0,useInlineFootnotes:!1,selectTextOnCommentClick:!1,excludeExcalidraw:!0,excludedFiles:[],dateFormat:"YYYY-MM-DD HH:mm",customColors:{yellow:"#ffd700",red:"#ff6b6b",teal:"#4ecdc4",blue:"#45b7d1",green:"#96ceb4"},customColorNames:{yellow:"",red:"",teal:"",blue:"",green:""}},J="highlights-sidebar",X=class extends E.Plugin{constructor(){super(...arguments);this.highlights=new Map;this.collections=new Map;this.sidebarView=null;this.detectHighlightsTimeout=null;this.selectedHighlightId=null;this.collectionCommands=new Set}async onload(){await this.loadSettings(),this.highlights=new Map(Object.entries(this.settings.highlights||{})),this.collections=new Map(Object.entries(this.settings.collections||{})),this.collectionsManager=new Q(this),this.inlineFootnoteManager=new B,"registerHoverLinkSource"in this.app.workspace&&this.app.workspace.registerHoverLinkSource("sidebar-highlights",{display:"Sidebar Highlights",defaultMod:!0}),this.registerView(J,t=>(this.sidebarView=new Y(t,this),this.sidebarView)),this.addRibbonIcon("highlighter","Open highlights",()=>{this.activateView()}),this.addCommand({id:"create-highlight",name:"Create highlight from selection",editorCallback:t=>{this.createHighlight(t)}}),this.addCommand({id:"open-highlights-sidebar",name:"Toggle",callback:()=>{this.toggleView()}}),this.registerEvent(this.app.workspace.on("editor-menu",(t,e,i)=>{e.getSelection()&&t.addItem(s=>{s.setTitle("Create highlight").setIcon("highlighter").onClick(()=>{this.createHighlight(e)})})})),this.registerEvent(this.app.workspace.on("file-open",t=>{t?this.loadHighlightsFromFile(t):(this.selectedHighlightId=null,this.sidebarView&&this.sidebarView.updateContent())})),this.registerEvent(this.app.workspace.on("editor-change",(t,e)=>{e instanceof E.MarkdownView&&this.debounceDetectMarkdownHighlights(t,e)})),this.addSettingTab(new nt(this.app,this)),this.addStyles(),this.registerCollectionCommands(),this.app.workspace.onLayoutReady(async()=>{await this.fixDuplicateTimestamps(),this.scanAllFilesForHighlights(),this.updateCustomColorStyles(),this.registerEvent(this.app.vault.on("create",t=>{t instanceof E.TFile&&this.shouldProcessFile(t)&&this.handleFileCreate(t)})),this.registerEvent(this.app.vault.on("rename",(t,e)=>{t instanceof E.TFile&&this.shouldProcessFile(t)&&this.handleFileRename(t,e)})),this.registerEvent(this.app.vault.on("delete",t=>{t instanceof E.TFile&&this.shouldProcessFile(t)&&this.handleFileDelete(t)}))})}onunload(){}async loadSettings(){let t=await this.loadData();t&&t.settingsVersion&&t.settingsVersion!==$.settingsVersion?await this.migrateSettings(t):(this.settings=Object.assign({},$,t),this.settings.settingsVersion||(this.settings.settingsVersion=$.settingsVersion,await this.saveSettings()))}async saveSettings(){this.settings.highlights=Object.fromEntries(this.highlights),this.settings.collections=Object.fromEntries(this.collections),await this.saveData(this.settings),this.updateStyles()}addStyles(){let t=document.createElement("style");t.id="highlight-comments-plugin-styles",this.applyHighlightTheme(),this.updateCustomColorStyles(),document.head.appendChild(t)}updateStyles(){this.applyHighlightTheme(),this.updateCustomColorStyles()}removeStyles(){let t=document.getElementById("highlight-comments-plugin-styles");t&&t.remove();let e=document.getElementById("highlight-comments-custom-colors");e&&e.remove(),this.removeHighlightTheme()}applyHighlightTheme(){this.removeHighlightTheme();let t=this.getHighlightThemeClass(this.settings.highlightColor);document.body.classList.add(t)}removeHighlightTheme(){["theme-highlight-default","theme-highlight-yellow","theme-highlight-red","theme-highlight-teal","theme-highlight-blue","theme-highlight-green"].forEach(e=>{document.body.classList.remove(e)})}getHighlightThemeClass(t){return{[this.settings.customColors.yellow]:"theme-highlight-yellow",[this.settings.customColors.red]:"theme-highlight-red",[this.settings.customColors.teal]:"theme-highlight-teal",[this.settings.customColors.blue]:"theme-highlight-blue",[this.settings.customColors.green]:"theme-highlight-green"}[t]||"theme-highlight-default"}updateCustomColorStyles(){let t=document.getElementById("highlight-comments-custom-colors");t&&t.remove();let e=document.createElement("style");e.id="highlight-comments-custom-colors";let i=`
            /* Dynamic hover color options */
            .hover-color-option[data-color="${this.settings.customColors.yellow}"] { background-color: ${this.settings.customColors.yellow} !important; }
            .hover-color-option[data-color="${this.settings.customColors.red}"] { background-color: ${this.settings.customColors.red} !important; }
            .hover-color-option[data-color="${this.settings.customColors.teal}"] { background-color: ${this.settings.customColors.teal} !important; }
            .hover-color-option[data-color="${this.settings.customColors.blue}"] { background-color: ${this.settings.customColors.blue} !important; }
            .hover-color-option[data-color="${this.settings.customColors.green}"] { background-color: ${this.settings.customColors.green} !important; }
            
            /* Dynamic group color squares */
            .group-color-square[data-color="${this.settings.customColors.yellow}"] { background-color: ${this.settings.customColors.yellow} !important; }
            .group-color-square[data-color="${this.settings.customColors.red}"] { background-color: ${this.settings.customColors.red} !important; }
            .group-color-square[data-color="${this.settings.customColors.teal}"] { background-color: ${this.settings.customColors.teal} !important; }
            .group-color-square[data-color="${this.settings.customColors.blue}"] { background-color: ${this.settings.customColors.blue} !important; }
            .group-color-square[data-color="${this.settings.customColors.green}"] { background-color: ${this.settings.customColors.green} !important; }
            
            /* Dynamic highlight theme colors */
            body.theme-highlight-yellow .cm-highlight { background-color: ${this.settings.customColors.yellow}66 !important; }
            body.theme-highlight-red .cm-highlight { background-color: ${this.settings.customColors.red}66 !important; }
            body.theme-highlight-teal .cm-highlight { background-color: ${this.settings.customColors.teal}66 !important; }
            body.theme-highlight-blue .cm-highlight { background-color: ${this.settings.customColors.blue}66 !important; }
            body.theme-highlight-green .cm-highlight { background-color: ${this.settings.customColors.green}66 !important; }
            
            /* Dynamic highlight card border colors */
            .highlight-item-card.highlight-color-yellow { border-left-color: ${this.settings.customColors.yellow} !important; }
            .highlight-item-card.highlight-color-red { border-left-color: ${this.settings.customColors.red} !important; }
            .highlight-item-card.highlight-color-teal { border-left-color: ${this.settings.customColors.teal} !important; }
            .highlight-item-card.highlight-color-blue { border-left-color: ${this.settings.customColors.blue} !important; }
            .highlight-item-card.highlight-color-green { border-left-color: ${this.settings.customColors.green} !important; }
            
            /* Dynamic highlight card selection colors */
            .highlight-item-card.highlight-color-yellow.highlight-selected { box-shadow: 0 0 0 1.5px ${this.settings.customColors.yellow}, var(--shadow-s) !important; }
            .highlight-item-card.highlight-color-red.highlight-selected { box-shadow: 0 0 0 1.5px ${this.settings.customColors.red}, var(--shadow-s) !important; }
            .highlight-item-card.highlight-color-teal.highlight-selected { box-shadow: 0 0 0 1.5px ${this.settings.customColors.teal}, var(--shadow-s) !important; }
            .highlight-item-card.highlight-color-blue.highlight-selected { box-shadow: 0 0 0 1.5px ${this.settings.customColors.blue}, var(--shadow-s) !important; }
            .highlight-item-card.highlight-color-green.highlight-selected { box-shadow: 0 0 0 1.5px ${this.settings.customColors.green}, var(--shadow-s) !important; }
        `;e.textContent=i,document.head.appendChild(e)}async activateView(){let{workspace:t}=this.app,e=null,i=t.getLeavesOfType(J);i.length>0?e=i[0]:(e=this.settings.sidebarPosition==="left"?t.getLeftLeaf(!1):t.getRightLeaf(!1),await(e==null?void 0:e.setViewState({type:J,active:!0}))),e&&t.revealLeaf(e)}async toggleView(){let{workspace:t}=this.app,e=t.getLeavesOfType(J);e.length>0?e.forEach(i=>i.detach()):await this.activateView()}async createHighlight(t){let e=t.getSelection();if(!e){new E.Notice("Please select some text first");return}let i=this.app.workspace.getActiveFile();if(!i){new E.Notice("No active file");return}let s=t.getCursor("from"),n=t.getCursor("to"),a=t.posToOffset(s),r=t.posToOffset(n),c={id:this.generateId(),text:e,tags:[],line:s.line,startOffset:a,endOffset:r,filePath:i.path,createdAt:Date.now()},h=this.highlights.get(i.path)||[];h.push(c),this.highlights.set(i.path,h);let g=`==${e}==`;t.replaceSelection(g),this.refreshSidebar(),new E.Notice("Highlight created")}refreshSidebar(){this.sidebarView&&this.sidebarView.refresh()}async reloadAllSettings(){await this.loadSettings(),this.collections=new Map(Object.entries(this.settings.collections||{})),this.highlights=new Map(Object.entries(this.settings.highlights||{})),this.registerCollectionCommands(),this.updateStyles(),this.refreshSidebar()}async createBackup(t){try{let e=new Date().toISOString().replace(/[:.]/g,"-"),i=`data-backup-${t}-${e}.json`,s={settingsVersion:this.settings.settingsVersion,collections:this.settings.collections,customColorNames:this.settings.customColorNames,highlights:this.settings.highlights,backupReason:t,originalTimestamp:e,backupCreatedAt:Date.now()},n=`.obsidian/plugins/sidebar-highlights/${i}`;await this.app.vault.adapter.write(n,JSON.stringify(s,null,2)),(t==="migration"||t==="manual")&&new E.Notice(`Settings backup created: ${i}`)}catch(e){console.error("Failed to create backup:",e),new E.Notice("Warning: Could not create settings backup")}}async migrateSettings(t){try{await this.createBackup("migration");let e=t.settingsVersion||"1.13.0",i=$.settingsVersion;e!==i&&new E.Notice(`Migrating settings from ${e} to ${i}...`);let s=t.collections||{},n=t.customColorNames||{},a=t.highlights||{};this.settings={...$},this.settings.collections=s,this.settings.customColorNames={...$.customColorNames,...n},this.settings.highlights=a,t.highlightColor!==void 0&&(this.settings.highlightColor=t.highlightColor),t.sidebarPosition!==void 0&&(this.settings.sidebarPosition=t.sidebarPosition),t.groupingMode!==void 0&&(this.settings.groupingMode=t.groupingMode),t.showFilenames!==void 0&&(this.settings.showFilenames=t.showFilenames),t.showTimestamps!==void 0&&(this.settings.showTimestamps=t.showTimestamps),t.showHighlightActions!==void 0&&(this.settings.showHighlightActions=t.showHighlightActions),t.showToolbar!==void 0&&(this.settings.showToolbar=t.showToolbar),t.useInlineFootnotes!==void 0&&(this.settings.useInlineFootnotes=t.useInlineFootnotes),t.selectTextOnCommentClick!==void 0&&(this.settings.selectTextOnCommentClick=t.selectTextOnCommentClick),t.excludeExcalidraw!==void 0&&(this.settings.excludeExcalidraw=t.excludeExcalidraw),t.excludedFiles!==void 0&&(this.settings.excludedFiles=t.excludedFiles),t.dateFormat!==void 0&&(this.settings.dateFormat=t.dateFormat),t.customColors!==void 0&&(this.settings.customColors={...$.customColors,...t.customColors}),this.settings.settingsVersion=i,this.collections=new Map(Object.entries(this.settings.collections||{})),this.highlights=new Map(Object.entries(this.settings.highlights||{})),await this.saveSettings(),e!==i&&(new E.Notice(`Settings successfully migrated to ${i}`),await this.validateCollectionReferences())}catch(e){console.error("Migration failed:",e),new E.Notice("Error during settings migration. Please check console for details.")}}async validateCollectionReferences(){try{let t=new Set;for(let s of this.highlights.values())s.forEach(n=>t.add(n.id));let e=0,i=[];for(let s of this.collections.values()){let n=s.highlightIds.filter(a=>!t.has(a));n.length>0&&(e+=n.length,i.push({name:s.name,brokenCount:n.length,totalCount:s.highlightIds.length}),s.highlightIds=s.highlightIds.filter(a=>t.has(a)))}if(e>0){let s=i.map(n=>`\u2022 ${n.name}: ${n.brokenCount}/${n.totalCount} references`).join(`
`);new E.Notice(`Migration complete, but ${e} highlight reference(s) couldn't be restored:

${s}

Broken references have been cleaned up. You may need to manually re-add some highlights to these collections.`,8e3),console.log("Collection validation results:",{totalBrokenReferences:e,collectionsWithIssues:i,message:"Some highlight references were lost during migration, likely due to file changes. Automatic cleanup completed."}),await this.saveSettings()}else new E.Notice("Migration successful! All collections and highlights preserved.",3e3)}catch(t){console.error("Collection validation failed:",t),new E.Notice("Warning: Could not validate collection references after migration.")}}async onExternalSettingsChange(){try{await this.createBackup("external-sync");let t=await this.loadData();t&&t.settingsVersion&&t.settingsVersion!==$.settingsVersion?await this.migrateSettings(t):await this.reloadAllSettings()}catch(t){console.error("Error handling external settings change:",t),await this.reloadAllSettings()}}registerCollectionCommands(){for(let t of this.collections.values()){let e=`go-to-collection-${t.id}`;this.addCommand({id:e,name:`Go to ${t.name}`,callback:()=>{this.goToCollection(t.id)}}),this.collectionCommands.add(e)}}unregisterCollectionCommands(){for(let t of this.collectionCommands)this.removeCommand(t);this.collectionCommands.clear()}async goToCollection(t){await this.activateView(),this.sidebarView&&this.sidebarView.navigateToCollection(t)}updateHighlight(t,e,i){let s=i,n;if(s)n=this.highlights.get(s);else for(let[r,l]of this.highlights)if(l.some(c=>c.id===t)){s=r,n=l;break}if(!s&&!i){let r=this.app.workspace.getActiveFile();r&&(s=r.path,n=this.highlights.get(s))}if(!s||!n)return;let a=n.findIndex(r=>r.id===t);if(a!==-1){let r={...n[a],...e},l=[...n];l[a]=r,this.highlights.set(s,l),this.saveSettings(),this.sidebarView&&this.sidebarView.updateItem(t)}}async loadHighlightsFromFile(t){if(this.selectedHighlightId?(this.highlights.get(t.path)||[]).find(n=>n.id===this.selectedHighlightId)||(this.selectedHighlightId=null):this.selectedHighlightId=null,!this.shouldProcessFile(t)){this.highlights.delete(t.path),this.sidebarView&&this.sidebarView.updateContent();return}if(await this.isExcalidrawFile(t)){this.highlights.delete(t.path),this.sidebarView&&this.sidebarView.updateContent();return}let e=await this.app.vault.read(t);this.detectAndStoreMarkdownHighlights(e,t),this.sidebarView&&this.sidebarView.updateContent()}debounceDetectMarkdownHighlights(t,e){this.detectHighlightsTimeout&&window.clearTimeout(this.detectHighlightsTimeout),this.detectHighlightsTimeout=window.setTimeout(()=>{this.detectMarkdownHighlights(t,e)},1e3)}async detectMarkdownHighlights(t,e){let i=e.file;if(!i)return;let s=t.getValue();this.detectAndStoreMarkdownHighlights(s,i)}async scanAllFilesForHighlights(){let e=this.app.vault.getMarkdownFiles().filter(n=>this.shouldProcessFile(n)),i=new Set(e.map(n=>n.path)),s=!1;for(let n of this.highlights.keys())i.has(n)||(this.highlights.delete(n),s=!0);for(let n of this.collections.values()){let a=n.highlightIds.length;n.highlightIds=n.highlightIds.filter(r=>{for(let[l,c]of this.highlights)if(c.some(h=>h.id===r))return!0;return!1}),n.highlightIds.length!==a&&(s=!0)}for(let n of e)try{if(await this.isExcalidrawFile(n)){this.highlights.has(n.path)&&(this.highlights.delete(n.path),s=!0);continue}let a=await this.app.vault.read(n),r=this.highlights.get(n.path)||[];this.detectAndStoreMarkdownHighlights(a,n,!1);let l=this.highlights.get(n.path)||[],c=JSON.stringify(r.map(g=>({id:g.id,text:g.text,start:g.startOffset,end:g.endOffset,footnotes:g.footnoteCount}))),h=JSON.stringify(l.map(g=>({id:g.id,text:g.text,start:g.startOffset,end:g.endOffset,footnotes:g.footnoteCount})));c!==h&&(s=!0)}catch(a){}s&&(await this.saveSettings(),this.refreshSidebar())}parseHtmlColor(t){let e=t.trim().toLowerCase(),i={yellow:"#ffff00",red:"#ff0000",green:"#008000",blue:"#0000ff",orange:"#ffa500",purple:"#800080",pink:"#ffc0cb",cyan:"#00ffff",magenta:"#ff00ff",lime:"#00ff00",brown:"#a52a2a",gray:"#808080",grey:"#808080",black:"#000000",white:"#ffffff"};return i[e]?i[e]:/^#([0-9a-f]{3}|[0-9a-f]{6})$/i.test(e)?e.length===4?"#"+e[1]+e[1]+e[2]+e[2]+e[3]+e[3]:e:null}detectAndStoreMarkdownHighlights(t,e,i=!0){let s=/==([^=\n](?:[^=\n]|=[^=\n])*?[^=\n])==/g,n=/%%([^%](?:[^%]|%[^%])*?)%%/g,a=/<span\s+style=["'][^"']*background:\s*([^;"']+)[^"']*["'][^>]*>(.*?)<\/span>/gi,r=/<font\s+color=["']([^"']+)["'][^>]*>(.*?)<\/font>/gi,l=/<mark[^>]*>(.*?)<\/mark>/gi,c=[],h=this.highlights.get(e.path)||[],g=new Set,p=(u,x,b,y)=>{let w=h.find(M=>!g.has(M.id)&&M.text===u&&M.startOffset===x&&M.endOffset===b&&M.isNativeComment===y);if(w)return g.add(w.id),w;let H=h.find(M=>!g.has(M.id)&&M.text===u&&Math.abs(M.startOffset-x)<=50&&M.isNativeComment===y);if(H)return g.add(H.id),H;let k=h.find(M=>!g.has(M.id)&&M.text===u&&M.isNativeComment===y&&!h.some(N=>N!==M&&N.text===u&&N.isNativeComment===y));if(k)return g.add(k.id),k},v=this.extractFootnotes(t),m=this.getCodeBlockRanges(t),f=[],d;for(;(d=s.exec(t))!==null;)if(!this.isInsideCodeBlock(d.index,d.index+d[0].length,m)){let u=t.charAt(d.index-1),x=t.charAt(d.index+d[0].length);if(u==="="||x==="=")continue;f.push({match:d,type:"highlight"})}for(;(d=n.exec(t))!==null;)if(!this.isInsideCodeBlock(d.index,d.index+d[0].length,m)){let u=t.charAt(d.index-1),x=t.charAt(d.index+d[0].length);if(u==="%"||x==="%")continue;f.push({match:d,type:"comment"})}for(;(d=a.exec(t))!==null;)if(!this.isInsideCodeBlock(d.index,d.index+d[0].length,m)){let u=this.parseHtmlColor(d[1]);if(u){let x=Object.assign([],d);x[1]=d[2],f.push({match:x,type:"html",color:u})}}for(;(d=r.exec(t))!==null;)if(!this.isInsideCodeBlock(d.index,d.index+d[0].length,m)){let u=this.parseHtmlColor(d[1]);if(u){let x=Object.assign([],d);x[1]=d[2],f.push({match:x,type:"html",color:u})}}for(;(d=l.exec(t))!==null;)if(!this.isInsideCodeBlock(d.index,d.index+d[0].length,m)){let u=Object.assign([],d);u[1]=d[1],f.push({match:u,type:"html",color:"#ffff00"})}f.sort((u,x)=>u.match.index-x.match.index),f.forEach(({match:u,type:x,color:b})=>{let[,y]=u;if(!y||y.trim()==="")return;let w=p(y,u.index,u.index+u[0].length,x==="comment"),H=t.substring(0,u.index).split(`
`).length-1,k=[],M=0;if(x==="highlight"||x==="html"){let N=t.substring(u.index+u[0].length),L=[];this.inlineFootnoteManager.extractInlineFootnotes(t,u.index+u[0].length).forEach(F=>{F.content.trim()&&L.push({type:"inline",index:F.startIndex,content:F.content.trim()})});let G=/(\s*\[\^(\w+)\])(?!:)/g,O,et=0;for(;(O=G.exec(N))!==null;){let F=N.substring(et,O.index),it=/^(\s*(\[\^[a-zA-Z0-9_-]+\]|\^\[[^\]]+\])\s*)*\s*$/.test(F);if(O.index===et||it){let ot=O[2];if(v.has(ot)){let lt=v.get(ot).trim();lt&&L.push({type:"standard",index:u.index+u[0].length+O.index,content:lt})}et=O.index+O[0].length}else break}L.sort((F,it)=>F.index-it.index),k=L.map(F=>F.content),M=k.length}else x==="comment"&&(k=[y],M=1);if(w)c.push({...w,line:H,startOffset:u.index,endOffset:u.index+u[0].length,filePath:e.path,footnoteCount:M,footnoteContents:k,isNativeComment:x==="comment",color:x==="html"?b:w.color,createdAt:w.createdAt||Date.now()});else{let N=e.stat.mtime+u.index%1e3;c.push({id:this.generateId(),text:y,tags:[],line:H,startOffset:u.index,endOffset:u.index+u[0].length,filePath:e.path,footnoteCount:M,footnoteContents:k,createdAt:N,isNativeComment:x==="comment",color:x==="html"?b:void 0})}});let T=JSON.stringify(h.map(u=>{var x;return{id:u.id,start:u.startOffset,end:u.endOffset,text:u.text,footnotes:u.footnoteCount,contents:(x=u.footnoteContents)==null?void 0:x.filter(b=>b.trim()!==""),color:u.color,isNativeComment:u.isNativeComment}})),S=JSON.stringify(c.map(u=>{var x;return{id:u.id,start:u.startOffset,end:u.endOffset,text:u.text,footnotes:u.footnoteCount,contents:(x=u.footnoteContents)==null?void 0:x.filter(b=>b.trim()!==""),color:u.color,isNativeComment:u.isNativeComment}}));T!==S&&(this.highlights.set(e.path,c),i&&(this.saveSettings(),this.smartUpdateSidebar(h,c)))}smartUpdateSidebar(t,e){var l,c;if(!this.sidebarView)return;let i=new Map,s=new Map;t.forEach(h=>i.set(h.id,h)),e.forEach(h=>s.set(h.id,h));let n=new Set(i.keys()),a=new Set(s.keys());if(n.size!==a.size||[...n].some(h=>!a.has(h))||[...a].some(h=>!n.has(h)))this.refreshSidebar();else for(let[h,g]of s){let p=i.get(h);if(p){let v=JSON.stringify({text:p.text,footnotes:p.footnoteCount,contents:(l=p.footnoteContents)==null?void 0:l.filter(f=>f.trim()!==""),color:p.color,isNativeComment:p.isNativeComment}),m=JSON.stringify({text:g.text,footnotes:g.footnoteCount,contents:(c=g.footnoteContents)==null?void 0:c.filter(f=>f.trim()!==""),color:g.color,isNativeComment:g.isNativeComment});v!==m&&this.sidebarView.updateItem(h)}}}extractFootnotes(t){let e=new Map,i=/^\[\^(\w+)\]:\s*(.+)$/gm,s;for(;(s=i.exec(t))!==null;){let[,n,a]=s;e.set(n,a.trim())}return e}async handleFileCreate(t){try{let e=await this.app.vault.read(t);this.detectAndStoreMarkdownHighlights(e,t,!1);let i=this.highlights.get(t.path);i&&i.length>0&&(await this.saveSettings(),this.refreshSidebar())}catch(e){}}async handleFileRename(t,e){let i=this.highlights.get(e);if(i&&i.length>0){let s=i.map(n=>({...n,filePath:t.path}));this.highlights.delete(e),this.highlights.set(t.path,s),await this.saveSettings(),this.refreshSidebar()}}handleFileDelete(t){if(this.highlights.has(t.path)){let e=new Set((this.highlights.get(t.path)||[]).map(s=>s.id));this.highlights.delete(t.path);let i=!1;for(let s of this.collections.values()){let n=s.highlightIds.length;s.highlightIds=s.highlightIds.filter(a=>!e.has(a)),s.highlightIds.length!==n&&(i=!0)}this.saveSettings(),this.refreshSidebar()}}getCurrentFileHighlights(){let t=this.app.workspace.getActiveFile();return t?this.highlights.get(t.path)||[]:[]}generateId(){return Math.random().toString(36).substr(2,9)}shouldProcessFile(t){return!(t.extension!=="md"||this.settings.excludeExcalidraw&&t.name.endsWith(".excalidraw.md")||this.isFileExcluded(t.path))}isFileExcluded(t){if(!this.settings.excludedFiles||this.settings.excludedFiles.length===0)return!1;let e=t.replace(/\\/g,"/");for(let i of this.settings.excludedFiles){let s=i.replace(/\\/g,"/");if(e===s||e.startsWith(s+"/"))return!0}return!1}async isExcalidrawFile(t){if(!this.settings.excludeExcalidraw)return!1;if(t.name.endsWith(".excalidraw.md"))return!0;try{let i=(await this.app.vault.read(t)).match(/^---\n([\s\S]*?)\n---/);if(i){let s=i[1];if(/excalidraw-plugin:\s*parsed/i.test(s)||/tags:\s*\[.*excalidraw.*\]/i.test(s))return!0}}catch(e){}return!1}async fixDuplicateTimestamps(){let t=!1;for(let[e,i]of this.highlights){let s=new Map;i.forEach(n=>{n.createdAt&&(s.has(n.createdAt)||s.set(n.createdAt,[]),s.get(n.createdAt).push(n))});for(let[n,a]of s)a.length>1&&(a.sort((r,l)=>r.startOffset-l.startOffset),a.forEach((r,l)=>{l>0&&(r.createdAt=n+l,t=!0)}))}t&&(await this.saveSettings(),this.refreshSidebar())}getCodeBlockRanges(t){let e=[],i=/^```[\s\S]*?\n```\s*$/gm,s=/^~~~[\s\S]*?\n~~~\s*$/gm,n;for(;(n=i.exec(t))!==null;)e.push({start:n.index,end:n.index+n[0].length});for(;(n=s.exec(t))!==null;)e.push({start:n.index,end:n.index+n[0].length});let a=/`([^`\n]+?)`/g;for(;(n=a.exec(t))!==null;)e.push({start:n.index,end:n.index+n[0].length});return e}isInsideCodeBlock(t,e,i){return i.some(s=>t>=s.start&&e<=s.end)}},nt=class extends E.PluginSettingTab{constructor(t,e){super(t,e);this.plugin=e}display(){let{containerEl:t}=this;t.empty(),new E.Setting(t).setHeading().setName("Display"),new E.Setting(t).setName("Show note titles in all notes and collections").setDesc("Display the filename/note title below highlights when viewing All Notes or Collections.").addToggle(r=>r.setValue(this.plugin.settings.showFilenames).onChange(async l=>{this.plugin.settings.showFilenames=l,await this.plugin.saveSettings(),this.plugin.refreshSidebar()})),new E.Setting(t).setName("Show note timestamps").setDesc("Display creation timestamps for highlights.").addToggle(r=>r.setValue(this.plugin.settings.showTimestamps).onChange(async l=>{this.plugin.settings.showTimestamps=l,await this.plugin.saveSettings(),this.plugin.refreshSidebar()})),new E.Setting(t).setName("Show highlight actions").setDesc("Display the actions area below each highlight (filename, stats, and buttons).").addToggle(r=>r.setValue(this.plugin.settings.showHighlightActions).onChange(async l=>{this.plugin.settings.showHighlightActions=l,await this.plugin.saveSettings(),this.plugin.refreshSidebar()})),new E.Setting(t).setName("Show toolbar").setDesc("Display the toolbar with search, grouping, and other action buttons.").addToggle(r=>r.setValue(this.plugin.settings.showToolbar).onChange(async l=>{this.plugin.settings.showToolbar=l,await this.plugin.saveSettings(),this.plugin.refreshSidebar()})),new E.Setting(t).setName("Date format").setDesc("Format string for timestamps using moment.js syntax (e.g., YYYY-MM-DD HH:mm, MMM DD YYYY, DD/MM/YYYY h:mm A)").addMomentFormat(r=>r.setValue(this.plugin.settings.dateFormat).setPlaceholder("YYYY-MM-DD HH:mm").onChange(async l=>{this.plugin.settings.dateFormat=l,await this.plugin.saveSettings(),this.plugin.refreshSidebar()})),new E.Setting(t).setHeading().setName("Styling");let e=new E.Setting(t).setName(`Highlight color: ${this.plugin.settings.customColors.yellow.toUpperCase()}`).setDesc("Customize the first highlight color.").addColorPicker(r=>r.setValue(this.plugin.settings.customColors.yellow).onChange(async l=>{this.plugin.settings.customColors.yellow=l,await this.plugin.saveSettings(),this.updateColorMappings(),e.setName(`Highlight color: ${l.toUpperCase()}`)})).addButton(r=>r.setButtonText("Reset").setTooltip("Reset to default yellow (#ffd700)").onClick(async()=>{this.plugin.settings.customColors.yellow="#ffd700",await this.plugin.saveSettings(),this.updateColorMappings(),e.setName(`Highlight color: ${this.plugin.settings.customColors.yellow.toUpperCase()}`),this.display()}));new E.Setting(t).setName("Highlight name").setDesc("Optional: Add a custom name for this color to use in Group By Color instead of the hex code.").addText(r=>r.setPlaceholder('e.g., "Important", "Research"').setValue(this.plugin.settings.customColorNames.yellow).onChange(async l=>{this.plugin.settings.customColorNames.yellow=l,await this.plugin.saveSettings(),this.plugin.refreshSidebar()}));let i=new E.Setting(t).setName(`Highlight color: ${this.plugin.settings.customColors.red.toUpperCase()}`).setDesc("Customize the second highlight color.").addColorPicker(r=>r.setValue(this.plugin.settings.customColors.red).onChange(async l=>{this.plugin.settings.customColors.red=l,await this.plugin.saveSettings(),this.updateColorMappings(),i.setName(`Highlight color: ${l.toUpperCase()}`)})).addButton(r=>r.setButtonText("Reset").setTooltip("Reset to default red (#ff6b6b)").onClick(async()=>{this.plugin.settings.customColors.red="#ff6b6b",await this.plugin.saveSettings(),this.updateColorMappings(),i.setName(`Highlight color: ${this.plugin.settings.customColors.red.toUpperCase()}`),this.display()}));new E.Setting(t).setName("Highlight name").setDesc("Optional: Add a custom name for this color to use in Group By Color instead of the hex code.").addText(r=>r.setPlaceholder('e.g., "Important", "Research"').setValue(this.plugin.settings.customColorNames.red).onChange(async l=>{this.plugin.settings.customColorNames.red=l,await this.plugin.saveSettings(),this.plugin.refreshSidebar()}));let s=new E.Setting(t).setName(`Highlight color: ${this.plugin.settings.customColors.teal.toUpperCase()}`).setDesc("Customize the third highlight color.").addColorPicker(r=>r.setValue(this.plugin.settings.customColors.teal).onChange(async l=>{this.plugin.settings.customColors.teal=l,await this.plugin.saveSettings(),this.updateColorMappings(),s.setName(`Highlight color: ${l.toUpperCase()}`)})).addButton(r=>r.setButtonText("Reset").setTooltip("Reset to default teal (#4ecdc4)").onClick(async()=>{this.plugin.settings.customColors.teal="#4ecdc4",await this.plugin.saveSettings(),this.updateColorMappings(),s.setName(`Highlight color: ${this.plugin.settings.customColors.teal.toUpperCase()}`),this.display()}));new E.Setting(t).setName("Highlight name").setDesc("Optional: Add a custom name for this color to use in Group By Color instead of the hex code.").addText(r=>r.setPlaceholder('e.g., "Important", "Research"').setValue(this.plugin.settings.customColorNames.teal).onChange(async l=>{this.plugin.settings.customColorNames.teal=l,await this.plugin.saveSettings(),this.plugin.refreshSidebar()}));let n=new E.Setting(t).setName(`Highlight color: ${this.plugin.settings.customColors.blue.toUpperCase()}`).setDesc("Customize the fourth highlight color.").addColorPicker(r=>r.setValue(this.plugin.settings.customColors.blue).onChange(async l=>{this.plugin.settings.customColors.blue=l,await this.plugin.saveSettings(),this.updateColorMappings(),n.setName(`Highlight color: ${l.toUpperCase()}`)})).addButton(r=>r.setButtonText("Reset").setTooltip("Reset to default blue (#45b7d1)").onClick(async()=>{this.plugin.settings.customColors.blue="#45b7d1",await this.plugin.saveSettings(),this.updateColorMappings(),n.setName(`Highlight color: ${this.plugin.settings.customColors.blue.toUpperCase()}`),this.display()}));new E.Setting(t).setName("Highlight name").setDesc("Optional: Add a custom name for this color to use in Group By Color instead of the hex code.").addText(r=>r.setPlaceholder('e.g., "Important", "Research"').setValue(this.plugin.settings.customColorNames.blue).onChange(async l=>{this.plugin.settings.customColorNames.blue=l,await this.plugin.saveSettings(),this.plugin.refreshSidebar()}));let a=new E.Setting(t).setName(`Highlight color: ${this.plugin.settings.customColors.green.toUpperCase()}`).setDesc("Customize the fifth highlight color.").addColorPicker(r=>r.setValue(this.plugin.settings.customColors.green).onChange(async l=>{this.plugin.settings.customColors.green=l,await this.plugin.saveSettings(),this.updateColorMappings(),a.setName(`Highlight color: ${l.toUpperCase()}`)})).addButton(r=>r.setButtonText("Reset").setTooltip("Reset to default green (#96ceb4)").onClick(async()=>{this.plugin.settings.customColors.green="#96ceb4",await this.plugin.saveSettings(),this.updateColorMappings(),a.setName(`Highlight color: ${this.plugin.settings.customColors.green.toUpperCase()}`),this.display()}));new E.Setting(t).setName("Highlight name").setDesc("Optional: Add a custom name for this color to use in Group By Color instead of the hex code.").addText(r=>r.setPlaceholder('e.g., "Important", "Research"').setValue(this.plugin.settings.customColorNames.green).onChange(async l=>{this.plugin.settings.customColorNames.green=l,await this.plugin.saveSettings(),this.plugin.refreshSidebar()})),new E.Setting(t).setHeading().setName("Comments"),new E.Setting(t).setName("Use inline footnotes by default").setDesc("When adding comments via the sidebar, use inline footnotes (^[comment]) instead of standard footnotes ([^ref]: comment).").addToggle(r=>r.setValue(this.plugin.settings.useInlineFootnotes).onChange(async l=>{this.plugin.settings.useInlineFootnotes=l,await this.plugin.saveSettings()})),new E.Setting(t).setName("Select text on click").setDesc("When clicking a comment, select the comment instead of positioning the cursor in front of it.").addToggle(r=>r.setValue(this.plugin.settings.selectTextOnCommentClick).onChange(async l=>{this.plugin.settings.selectTextOnCommentClick=l,await this.plugin.saveSettings()})),new E.Setting(t).setHeading().setName("Filters"),new E.Setting(t).setName("Exclude Excalidraw files").setDesc("Skip .excalidraw files when scanning for highlights. This prevents highlights from being detected in Excalidraw drawing files.").addToggle(r=>r.setValue(this.plugin.settings.excludeExcalidraw).onChange(async l=>{this.plugin.settings.excludeExcalidraw=l,await this.plugin.saveSettings(),this.plugin.scanAllFilesForHighlights()})),new E.Setting(t).setName("Excluded files").setDesc("Excluded files or folders will be hidden from Sidebar Highlights").addButton(r=>{r.setButtonText("Manage").onClick(()=>{new Z(this.app,this.plugin.settings.excludedFiles,async c=>{this.plugin.settings.excludedFiles=c,await this.plugin.saveSettings(),this.plugin.scanAllFilesForHighlights()}).open()})})}updateColorMappings(){this.plugin.refreshSidebar(),this.plugin.updateStyles()}},Q=class{constructor(o){this.plugin=o}createCollection(o,t){let e={id:this.plugin.generateId(),name:o,description:t,highlightIds:[],createdAt:Date.now()};return this.plugin.collections.set(e.id,e),this.plugin.saveSettings(),this.plugin.registerCollectionCommands(),e}deleteCollection(o){let t=`go-to-collection-${o}`;this.plugin.collectionCommands.has(t)&&(this.plugin.removeCommand(t),this.plugin.collectionCommands.delete(t)),this.plugin.collections.delete(o),this.plugin.saveSettings()}async deleteCollectionWithConfirmation(o){let t=this.plugin.collections.get(o);return t&&confirm(`Are you sure you want to delete "${t.name}"?`)?(this.deleteCollection(o),!0):!1}addHighlightToCollection(o,t){let e=this.plugin.collections.get(o);e&&!e.highlightIds.includes(t)&&(e.highlightIds.push(t),this.plugin.saveSettings())}removeHighlightFromCollection(o,t){let e=this.plugin.collections.get(o);e&&(e.highlightIds=e.highlightIds.filter(i=>i!==t),this.plugin.saveSettings())}getAllCollections(){return Array.from(this.plugin.collections.values())}getCollection(o){return this.plugin.collections.get(o)}getCollectionStats(o){let t=this.plugin.collections.get(o);if(!t)return{highlightCount:0,fileCount:0,nativeCommentsCount:0};let e=new Set,i=0,s=0;for(let n of t.highlightIds)for(let[a,r]of this.plugin.highlights){let l=r.find(c=>c.id===n);if(l){e.add(a),l.isNativeComment?s++:i++;break}}return{highlightCount:i,fileCount:e.size,nativeCommentsCount:s}}getHighlightsInCollection(o){let t=this.plugin.collections.get(o);if(!t)return[];let e=[];for(let i of t.highlightIds)for(let[s,n]of this.plugin.highlights){let a=n.find(r=>r.id===i);if(a){e.push(a);break}}return e}getHighlightCollectionCount(o){let t=0;for(let e of this.plugin.collections.values())e.highlightIds.includes(o)&&t++;return t}getCollectionsForHighlight(o){let t=[];for(let e of this.plugin.collections.values())e.highlightIds.includes(o)&&t.push(e);return t}};

/* nosourcemap */